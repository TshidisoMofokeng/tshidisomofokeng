---
bibliography: "C:/Users/User/OneDrive - University of Pretoria/Tuks/Honours/EKT 795/Research
  Paper/References bib file/export.bib"
output:
  html_document:
    df_print: paged
  pdf_document:
    number_sections: yes
    latex_engine: pdflatex
    pandoc_args:
    - "--variable=geometry:margin=1in"
    - "--variable=fontsize:11pt"
    - "--variable=mainfont:Times New Roman"
    - "--variable=classoption:justified"
    - "--variable=setspace:stretch=2"
    - "--variable=line-height:1.5"
link-citations: yes
code_download: true
---

```{r setup, include=FALSE, echo=F}
knitr::opts_chunk$set(echo = TRUE)
library(kableExtra)
library(readxl)
library(tidyverse)  
library(haven) 
library(mlogit)
library(stargazer)
library(unglue)
library(dfidx)
```

\newpage

\thispagestyle{empty}

\begin{center}
  \Huge{\textbf{Drivers of Access to Credit in South Africa}}
  \par
  \vspace*{2cm}
  \Large{Submitted in fulfilment of the requirements for the degree Honours in Econometrics \\}
  \vspace*{1.5cm}
  \Large{in the \\}
  \vspace*{1.5cm}
  \Large{FACULTY OF ECONOMIC AND MANAGEMENT SCIENCES \\}
  \vspace*{1.5cm}
  \Large{at the \\}
  \vspace*{1.5cm}
  \Large{UNIVERSITY OF PRETORIA \\}
  \vspace*{1.5cm}
  \Large{Author: Tshidiso Mofokeng, 19242175\\}
  \vspace*{1.5cm}
  \Large{Supervisor: Dumakude Nxumalo\\}
  \vspace*{1.5cm}
  \Large{Date: 24 October 2023}
\end{center}

\newpage

\begin{center}
  \Huge{\textbf{Drivers of Access to Credit in South Africa}}
  \par
  \vspace*{2cm}
\end{center}

\begin{center}
\textbf{Abstract}
\end{center}

<div style="text-align: justify;"> 
This study extends the limited evidence on access to credit in South Africa. We investigate the role that demographics and the transactional behaviour at individual level play in influencing the probability of gaining access to different types of credit. We make use of recent data from the FinScopeSA 2019 Consumer Survey. We estimate a multinomial logit choice model to establish the influence of various covariates on the likelihood of an individual gaining access to formal, informal, and a combination of formal and informal credit with our reference category being those who have no access to credit. We find that age, income, higher educational attainment, living in Gauteng or Free State and higher LSM being statistically significant, increasing an individual likelihood for access to formal credit. Furthermore, we find that age, income, employment status, remittances, and LSM being positive and statistically significant at increasing the probability of individuals having access to the combination of formal and informal credit. On the other hand, Indian or Asian individuals, employments status and remittances lowered the likelihood of an individual having access to formal credit. Compared to being male for the combination of formal and informal credit.
</div>


# Introduction 

In the early 2000s, a small proportion of citizens in South Africa had access to credit. Most if not all financial institutions conducted business within their banking profitability frontier and were weary as to adopting higher risk by extending their frontier to reach the previously unbanked individuals through various means. Bottlenecks such as financial institutions reluctance slowed credit extensions especially to individuals who could not provide evidence that they are low-risk customers either via collateral or sufficiently satisfactory earnings potential. Also, @Okurut2006 suggested that, burning the bridge of access to credit, would be reducing asymmetric information and market imperfections, as they tend to increase the probability of default for individuals in the eyes of lenders. Moreover, low risk appetite from the financial institutions has resulted in less banks, at the time, tapping into the market of lower income individuals known as 'risky' customers as they might not have seen this as a rewarding exercise.

The landscape of credit has much evolved as efforts to bolster higher access to formal credit have improved. Through policy framework such as the National Credit Act which reduced uncertainty in the credit market, a few more banks were able to enter and extend original banks' frontier to reach more individuals. Moreover, the formalization of unsecured lending led to stronger bank expansion into credit segments such as unsecured lending as well as personal loans which reached and attracted a new and previously untouched client base. Furthermore, the likes of Capitec bank took advantage of regulatory changes and were able to play a role in democratizing access to credit. As a result of a few new banks entering the market, this led to expansion in the credit division of banks financial product and service offerings. The spillover effect has resulted in overall formal credit significantly improving overtime. 

In South Africa, a fairly large proportion of citizens still use informal channel of credit. According to @Fin, about 20% and 17% of individuals were borrowing via an informal channel (loan shark or mashonisa) and from friends and family, respectively in the year 2022. Unequivocally, the issue with such statistics is that this entire channel of credit still remains unregulated. Hence, individuals have minimal protection from a legal standing. On the other hand, @Fin explains that, 88% of individuals that borrow from a formal channel of credit either borrow from a bank or non-bank financial institutions where the underwriter of the credit being extended is a bank. 

A few factors have been identified as drivers of access to credit on individual level. That is, personal income as well as living in urban areas. This is owing to, income being a sound indicator to an individuals ability to be able to repay the credit extended. Alternatively, banks may be less inclined to extend to extend credit to those who earn grants or do not earn income at all. On the other hand, most financial institutions are mainly around urban areas or a metropolitan and so the greater proximity of an individual to financial institutions may be a driver of access to credit. Then also age as a factor, since it may give glimpses to the borrower on the individuals how much of a credit history a said individual has. Lastly, race may also be a factor. 

In assessing what are the drivers of access to credit, more specifically, drivers of individual choices of different credit types. We make use of a multinomial model to predict the probability of a given individual having access to either formal, informal or the combination of formal and informal credit. From this we find that, determinants with positive and statistically significant explanatory power in explaining why an individual would have access to formal credit are age, income, higher educational attainment, living in Gauteng or Free State. Furthermore, for the combination of formal and informal credit we have age, income, employment status, remittances as well as a higher living standard measure (LSM). 

Our contribution to the literature is that we seek to extend previous studies on access to credit predominately in South Africa. From a evidence and literature perspective, much efforts have been directed towards documenting financial inclusion. However, our focus narrows down on credit exclusively, of which the last study which does something similar dates back to 2006. Hence, we extend on that by using the latest data as well as information. Moreover, a feature which adds a level of nuance from previous studies to date, which have only looked at individual channels of access and not the combination of channels to credit. For this reason, we seek to exploit this gap in the literature by adding another choice variable, that being, the individuals who have access to the combination of formal and informal credit. This might not have been a possible avenue of study in the early 2000s as regulatory ground was still young.

This study first dives into a literature review. Then, we provide a methodology and data section. Thereafter, we discuss the model framework in detail. Subsequently, we provide the results section and shortly after followed by an analysis of the determinants of access to credit. In addition, we provide a discussion section and before concluding we mention a few limitations and areas for further research. 


# Literature review


Financial inclusion is defined as individual access to a diverse range of products. These include being a transactional account, payments, savings, credit and insurance [@WorldBank]. The Financial Sector Regulation Act of South Africa similarly defines it with individuals having access to appropriate and affordable financial products and services [@FSCA]. Financial inclusion can also be, according to @NT, the provision and utilization of inexpensive and acceptable financial services by those parts of society where financial services are required but are not available or are given in an unsatisfactory manner. By definition alone, we note that financial inclusion is broad as it refers to various types of products. Consequently, efforts at improving it may not be as focused and in essence challenging to achieve, given the level of broadness. An individual having an account and being able to facilitate transactions through basic banking services quantifies them as being financially included. However, for the purpose of this paper we will be diving deeper into one of the branches of financial inclusion, that being credit. Access to credit is not as broad as financial inclusion. An individual can be financially included; however, they might not have access to credit. Furthermore, @Cull2018 explains that, lack of access to credit or any other formal financial service does not imply that the same group of individuals (given they are poor or unemployed) will not have access to any financial services. 

Credit quality of an individual plays an important role, especially with huge acquisitions such as homes. @Barakova2003 finds that, strong credit scores seems to improve the likelihood of owning assets such as vehicles and houses. However, the only way to have a strong credit score is to have access to credit, this in turn improves your credit quality. Moreover, the role access to credit plays is significant, in that, individuals are allowed to accumulate 'wealth' through, investing in human capital from household level, which comes down to improving future or potential output [@NationalTreasury]. @Kumar2020 explains how access to credit sources for rural households can enhance household income and reduce poverty. 

@Fatoki&Smit suggests that, credit rationing factors such as asymmetric information, moral hazard as well as adverse selection weigh in on the limitations for micro businesses on being granted access to credit, implicitly boiling down to the capital structure of such businesses. More so, the assets in ownership that can be used as collateral. These micro businesses such as street vendors or corner stores, are largely an extension of an individual. This implies that any credit that is extended to these micro businesses are predominately applied for through personal financing, in essence, the owner has unlimited liability or is fully liable for the repayment of the debt in the case that the business is no longer able to generate revenue [@masiak2019micro]. Given the significant role micro businesses play in the informal sector of the economy with employment ^[The informal sector contributes an estimated 36% to GDP and contribution and it also contributes about 47% towards employment, according to [@StatsSA].] for semi- and unskilled-labour especially in developing nations, we may appreciate how access to credit adds a layer of economic transformation which can be more meaningful than financial inclusion which is diversified over not only credit but other products as well [@NT].


Historically, South Africa has had low levels of access to credit. @Okurut2006 explains how salaried workers in the period of 1995, who were predominately white, are more likely to gain access to credit. This indirectly implied that citizens who did not have a payslip or anything to use as collateral (house, car, investments) were most likely excluded from the credit market. In 1995, approximately 10.49% of citizens only had access to credit. At national level considering all races and genders, saw an increase in access to credit to 23.45% by the year 2000. According to @Msanzi2009, some banks felt less inclined to extend their banking frontier to reach lower income individuals' or the unbanked market.

@Msanzi2009 further explains that, financial products such as the Mzansi bank account helped to encourage banks to consider banking those at the near bottom of the income pyramid through reaching the so called last frontier of profitability. On the other hand, there are a few fast growing firms i.e. Discovery Bank, Bank Zero and TymeDigital aiming to claim a market share of the banking sector, through various financial product and service offerings including credit extensions.

A few supply-side factors cause barriers to entry to credit markets. Given that legal framework was a huge gap in the credit market around early 2000s, the National Credit Regulation which was formed by the National Credit Act (NCA) closed this gap after being established in 2005. The NCA which then oversaw regulation in the credit industry in South Africa, helped improve overall access to credit since its inception around mid 2006 [@Louw2006]. This policy move assisted Capitec in taking full advantage by offering higher loan amounts and longer repayment terms [@Makhaya2016]. This led to Capitec capturing a higher proportion of the middle and even lower income class. The NCA doing away with capital restraints under the Usury Act, saw Capitec expanding quicker via their credit segment which spilled over into a larger transactional customer base [@Makhaya2016]. More specifically, this bolstered growth in the overall credit market. 

We have seen an uptick to 88% of the adult population having access to formal credit, which include store cards and store accounts since the underwriter of this credit facility is a commercial bank, as at 2021 [@Fin]. Overall, holding all other factors constant, we have seen a significant increase in access to credit (all types of credit) from early 2000s to 2021. However, a number of individuals still use the informal channel of credit as, of which the usage has largely been driven by short term consumption uses instead of longer term productive uses. According to @Fin, about 37% of individuals still make use of informal credit channel of which includes loan sharks as well as borrowing from friends and family, which is a substantial amount of individuals.

Household or individual characteristics are also drivers of credit access in South Africa. The only South African study that evaluates access to credit was done in 2006 by Okurut. @Okurut2006 examines and finds that, determinants of access to credit would be employment status, education level, age, per capita expenditure, race and whether an individual is male. This is for the formal sector. Moreover, there is an added negative contribution towards predicting the dependent variable in the model that being whether an individual is poor or not. This effect can be controlled for with income where an individual who earns below a set threshold could be considered poor or perhaps those who fail to meet collateral requirement thresholds are factors that also play a significant role. @Okurut2006 then extends his analysis for the semi-formal sector, by mentioning that an individual being unemployed is not a significant reason as to why the barriers to entry might be high for the given individual. He notes that household size, per capita expenditure, provincial location, gender, being poor, staying in rural areas and race played a significant role in determining whether an individual would have access to semi-formal credit. Then, for the informal sector, are simply provincial location, education level and race. From the onset we see how the formal sector takes up much more variables which focus on whether a said individual can qualify and afford access to credit using a multinomial logit model. The number of drivers in the semi-formal and informal sector are more relaxed for the former and extremely relaxed for the latter. The semi-formal and informal sector do not necessarily run a form of regression model to determine whether an individual has access merely due to the nature of the client base being unemployed in most cases and even poor. The take on risk from borrowers is much higher given that such a client base is more susceptible to default, as a result, the interest on such forms of credit tend to be way higher than formal traditional commercial banks. Lastly, @Okurut2006 focused on variables that were consistent in both sample periods of 1995 and 2000 as well as coefficients with consistent signs. This study was however conducted in 2006. There has been notable developments in access  as well as demographics that may have been important in back then but may no longer capture. For instance, the expansion of banks in more locations may result in the geographic variable no longer holding explanatory power.   


In other studies from Vietnam, household and individual characteristics have also been identified as important in explaining access to credit. @Quach2005 suggested a similar approach in line with with quantifying the impact of access to credit on economic welfare of households to Okurut at household level. Characteristics that play a role in whether a household receives access to credit are; age of household head, gender of household head, size of household, education, ownership of land, household per capita food spending and non-food spending, household assets. @Quach2005 focused on agricultural data, and found that land ownership was most important in whether a farmer gained access to credit or not, with this explanatory variable being significant at a 1% level. At the time borrowers required land ownership certification in the administration process prior to approving credit extensions. Here characteristics influencing whether a rural households ability to borrow includes; age of household head, education, household size, land size and ownership of land, livestock or assets, direct cash transfer (grants), remittances and source of income. The only sources of borrowing are via formal (commercial banks, micro-finance institutions, cooperative bank) and informal (relatives or friends, money lender). Lastly, @Linh2019 looks at determinants of access to capital and mentions them namely as; gender, age, household size, distance between borrower and lender, education, access to information, area of land, assets (which can be used as collateral), household savings, marital status, past credit, social capital - how many people one could ask for help or just reputation. Among the most important, age, education, assets, credit record and income. 


#  Methodology and Data

A data source which provides us with relevant data for our research, will be obtained from FinMark Trust, FinScope survey of 2019. The FinScope survey is conducted each year in order to track and better understand individual and households access to, use of as well as demand for financial products and services. Through interviewing respondents', the level of participation in the financial services through savings, credit usage, and other financial products was captured. The 2019 survey is comprised of a sample of 4969 individuals. Additionally, all races were accounted for, a nationally representative sample of 16 years + participants were captured in the survey which was weighted and bench-marked according to the mid-year population estimates [@StatsSA]. Here we have, nationally representative survey and weighted these individuals represent 40.9 million citizens - see table 1. The sample design was outsourced by a third party. A tablet was used to collect the data through face to face interviews, with the questionnaire having the option of being translated into isiXhosa, isiZulu, Sesotho, Setswana, Sepedi and Afrikaans. This gives us added layers of assurance with respect to the quality and reliability of the survey data. 

The goal was for us to categorize individuals into four different groups. Namely those with access to, formal credit, informal credit, formal and informal credit and no credit which forms our choice variables. Firstly, we defined individuals with access to formal credit as those who in the past 12 months have successfully been able to borrow capital either from a bank, Retail Store (e.g. Woolworths, Edgars etc), Insurance company, Micro finance institution e.g. Wonga, Village bank or Co-operative bank (e.g. Yebo, Iemas), Development bank, NGO or government. Secondly, we then classified informal credit category as those who in the past 12 months have successfully been able to borrow capital either from an employer (including getting an advance on your salary), mashonisa or loan shark, stokvel society, burial society, umgalelo or savings club, Pawn shop, borrowed or taken goods (e.g. sugar, bread, milk, candles etc) or paying overtime for things on the book from a local spaza, general dealer, corner cafe or shop, colleagues or neighbours, friends or family or household member. Lastly, anyone who in the past 12 months did not borrow through either a formal or informal credit avenue was classified as not having access to credit. 

There are subtle differences on the approach we take compared to the likes of [@Okurut2006]. That is, @Okurut2006 defined three types of credit: formal, semi-formal and informal. By his definition, formal included credit strictly from commercial banks. Semi-formal included store accounts and store cards which are predominately associated with concept of consumption credit. Then, informal credit would include borrowing from friends and family. In our paper, we opted to draw a line between formal and informal; where, if the borrower is the bank or the credit is being underwritten by a financial institution through a retailer that offers a store card to an individual. Then we classify that as formal credit. Conversely, any borrowing that is not underwritten by a financial institution, then we classify that as informal credit. Furthermore, we consider evaluating individuals who use the combination of formal and informal credit. A choice not considered by @Okurut2006. Due to, institutional factors, @Okurut2006 explains that, banks limited credit supply by placing barriers since the opportunity cost of assessing whether an individual without minimum requirements qualifies was not a rewarding exercise. However, lowered barriers as well as a increased frontier has encouraged more banks overlook fact that in some if not most cases, it is not a rewarding case. 

From table 1, we notice the channel with the highest individuals is formal credit followed by informal credit with 458 and 369 individuals respectively. We noted that there were about 111 observations which had a combination of both formal and informal credit. The individuals or households that had access to both formal and informal credit according to the weighting of the 2019 StatsSA estimates were about 608,813 - see table 1. The environment and market for credit usage has evolved significantly from the early 2000s where one would most likely only have access to one form of credit channel. For instance, those who already had access to formal credit might have seen informal credit being too expensive with respect to the debt servicing cost. On the other hand, those with access to informal credit might not have been able to access formal channels given the high barriers of entry. However, the landscape is much more different; whereby, individuals do indeed participate through combinations of both formal and informal channels. Much so that, removing this from the data set would merely be as interesting as adding this level for study purposes. We keep this as a choice in order to incorporate these borrowing dynamics. 

```{r Summary by Credit type, echo=FALSE}

sum_stats <- read_xlsx("C:/Users/User/OneDrive - University of Pretoria/Tuks/Honours/EKT 795/Research Paper/Building Dataset code/summary stats final.xlsx")

#sum_stats$`Weighting by StatsSA` <- format(sum_stats$`Weighting by StatsSA`, big.mark = " ")


kable(sum_stats, longtable = F, booktabs = T, caption = "Summary by Credit Type", linesep = " ",format.args = list(big.mark=" "), digits = 0) %>% 
   kable_styling(latex_options = c("striped", "HOLD_position"), full_width = F, font_size = 9) %>% 
  row_spec(0, bold = T) %>% 
  row_spec(5, bold = T) 

```

We then noted 5 individuals in the data, otherwise relatively speaking about 36,699 citizens according to the weighting scale, who did not record that they have access to either formal, informal, formal and informal as well as no credit. This is approximately 0.1% of our sample which will be excluded. Hence, the sample was reduced to a total of 4964. Thus, based on the above defined types of credit we categorized individuals  into their relevant grouping by credit type - see table 1. 


# Descriptive Statistics

Table 2 provides the population weighted averages for individuals of the individual characteristics used in our analysis by credit type. The characteristics of interest would include the demographics of the individuals such as household size, age, income, race, income, provincial location, employment status, marriage status, educational level and LSM. In addition, transaction behaviour based on whether an individual is cash based or not which includes remittances as well as if an individual is cash based on household spending. 

Firstly, for demographics, we that individuals who have access to formal credit, earn R14,382 on average compared to individuals with access to informal credit who earn around R5032 on average. As expected individuals who use a combination of formal and informal credit, on average, earn almost 3x more than just those who use informal credit. In building the data set, those who belong to or participate in savings groups, stokvel groups, burial groups, or any other groups were all defined as individuals belonging to a social group. From this, we noted that such individuals were participating, on average, 58% via the combination channel of formal and informal credit but even higher for informal credit which was 61%. Intuitively, most financial institutions have only in recent years started creating financial products such as stokvel accounts, in efforts to start banking much of the previously unbanked communities. Table 2 also indicates how the Black individuals have higher access to informal and no access to credit at 89% and 79% respectively. Moreover, White individuals have a greater proportion of individuals with access to formal credit, compared to, informal as well as no credit where those percentages are relatively low. On the contrary, Indian or Asian individuals have the lowest access to all channels of credit. We expect individuals from rural areas to have low participation rates for financial inclusion and subsequently access to different types of credit compared to individuals in urban areas, that is 13% in rural areas which is 4.9x lower than those who use formal credit in urban areas. On the other hand, in line with expectation, evidence confirms that 93% of individuals who are employed have access to the combination of formal and informal credit in comparison to unemployed individuals who approximately do not have access to formal credit. Higher percentage of unemployed individuals are prone to either having access to informal credit and even no access at all to credit. This could be explained by the employment figures of the nation, with less individuals having quality (high-skilled) jobs in the composition of the labour market. Also, one may overlay the high income inequality disparity in South Africa, which may lead to banks being cautious as to the kind of clients that credit is being extended to. 

Lastly, with respect to remittances, we expect formal institutions to be more reluctant to extend credit to individuals who send money out of the country. Formal lending institutions in most cases may have such information on their clientele, however, this would not entirely invoke a blockage on the supply of credit.  


```{r Descriptive stats, echo=F}

descr_stats <- read_xlsx("C:/Users/User/OneDrive - University of Pretoria/Tuks/Honours/EKT 795/Research Paper/Building Dataset code/descriptive stats final15.xlsx", sheet = "final")

kable(descr_stats, longtable = T, booktabs = T, caption = "Descriptive statistics", linesep = "        ", digits = 2) %>% 
   kable_styling(latex_options = c("striped", "HOLD_position"), full_width = F, font_size = 7) %>% 
  row_spec(0, bold = T) %>% 
  column_spec(1, bold = T, width = "5cm") %>%
  column_spec(4, bold = F, width = "2.5cm") %>%
  column_spec(6, bold = T, width = "7cm") %>%
  landscape()
```


# Model framework 

We make use of the multinomial logit model in order to determine the effect of various characteristics on the likelihood of gaining access to the different categories of credit. In essence, our goal is to try and understand why an individual will receive either formal, informal, formal and informal or no access to credit. That gives us four response variables, with our reference group being the participants' of the survey that do not have access to credit. Our reference group implies that, all coefficients associated with no credit have been normalized to zero, meaning that our results are interpreted with respect to individuals having no credit. Given a variety of covariates, we seek to explain what the probability is of having access to a certain type of credit.  

An alternative discrete choice probability model we could have considered would revolve around the Linear Probability Model (LPM) which simply is strictly a binary response model that takes on a qualitative dependent variable [@Wooldridge2012]. The interpretation thereafter would be in terms of the probability or rather changes in probability. However, the outcome as would be binary given the nature of the model only being a binary response model. This model would inherently pose a challenge to the work we are trying to unmask here, owing to the fact that, we are interested in an outcome that takes on four responses. Moreover, probabilities are defined between zero and one; however, for the LPM some extreme probabilities (outliers) may fall outside these bounds. Consequently, this runs us into statistical problems. Another shortcoming is that the marginal effects, for interpretation purposes, for any explanatory variable that appears in level form will be constant. Hence, we can not use the LPM estimation approach. We then turn to the multinomial logit model of estimation. This overcomes the shortcomings of the LPM mentioned above, although the interpretation does become a bit more challenging as we move outside of the world of Ordinary Least Squares. A richer model would not only look at formal vs informal credit. We now need to turn to a increasingly flexible model which will help us answer our question. 


$$
y  = 
\begin{cases}
    1, & \text{if } \ \text{formal }  \text{credit} \\
    2,  & \text{if } \ \text{informal }   \text{credit} \\
    3,  & \text{if } \ \text{formal and informal }  \text{credit}\\
    4,  & \text{if } \ \text{no }  \text{credit} \\
\end{cases}
$$


Hence, we have our probability function given as:
$$
E(y | X_i) = P(y= i | x_i) = G(\alpha_{i0} + \gamma_{i1} x_{n1} + \gamma_{i2} x_{n2} + \ ... \ + \gamma_{ik} x_{nk}) = G(\mathbf{x_{nk} \gamma_{ik}}) 
$$
for i = 1, 2, 3 and 4 and also where 0 $\leq$ G(.) $\leq$ 1. The multinomial logit closed form expressions uses an extreme value distribution for G [@Train]. Hence, this produces the following choice probability,

$$
P_{ni} = \frac{e^{v_{ni}}}{\sum_{j = 1}^{4} e^{v_{nj}}} 
$$
where $v_{ni} = \mathbf{x_{nk} \gamma_{ik}}$ and where n represents person n in our sample.

The discrete choice (in our case the multinomial model) analysis will focus on defining the model as we have above and then interpreting the estimates which will follow in the results section. We assume strict exogeniety for our unobservable factors or error term with our explanatory variables. Other properties for the choice probability include that our probabilities are indeed bounded between zero and one - a prerequisite for a probability by definition - as shown in figure 1. Given that $e$ is a strictly increasing function the probability approaches one as $v_{ni}$ increases, the converse also holds. Additionally, the denominator (in the above defined logit choice probability) ensures that the choice probabilities add up to one. This makes it slightly easier to interpret the probabilities, given that the denominator is just the sum of all the alternatives. The alternatives being the different types of access to credit. Hence, an increase in the usage of formal credit may reduce the probability of usage of informal credit. The characteristics that feed into predicting the probability of the different types of credit is household size, age, gender, personal income, household expenditure, ethnic group, province of residence, whether one stays in an urban metro or non-metro that is urban, marriage status, employment status, education level, levels of remittances, whether an individual is cash based as well as other variables.   


```{r Logit Curve Plot, echo=FALSE, warning=FALSE}
# Generate some example data
set.seed(123)
x <- seq(-5, 5, by = 0.1)
y <- 1 / (1 + exp(-x))  # Logistic function

# Fit a logistic regression model
data1 <- data.frame(x = x, y = y)
model1 <- glm(y ~ x, data = data1, family = binomial(link = "logit"))

# Create a new data frame for prediction
new_data <- data.frame(x = seq(-5, 5, by = 0.01))

# Predict probabilities using the model
predicted_probs <- predict(model1, newdata = new_data, type = "response")

# Plot the logistic curve
plot(x, y, type = "l", col = "blue", main = 'Figure 1: Logit curve', ylim = c(0, 1), xlab = "Vni", ylab = "Probability")
lines(new_data$x, predicted_probs, col = "red", lwd = 2)
abline(h = 1, lty = 2, col = "black")
```


Consider we are interested in understanding the marginal effect of education, more specifically tertiary education on the probability of an individual having access to formal credit. As mentioned earlier, running a regression of formal credit on education as well as other explanatory variables and reading the coefficient on education will only yield an incorrect interpretation of the magnitude of education even though the sign of the coefficient may be correct. For this reason, we seek to take a further step in reaching an interpretable solution to the problem. Given that that tertiary education is a binary variable, for instance, an individual can either have tertiary education or not. Hence, we take our marginal effect on tertiary education accounting for the discrete nature of the function with respect to how the function will be differentiated, using the chain rule from calculus. According to [@cameron2005], the marginal effect averaged over individuals will become,

$$\frac{\partial P_{ni}}{\mathbf{\partial x}_{nk}} = N^{-1} \sum_{i = 1}^{N} P_{ni}\ (\gamma_{ik} - \bar{\gamma}_{nk})$$

where, $N = 4964$ and $$ \bar{\gamma}_{nk} =  {\sum_{\forall l}} \ P_{nl} \ \gamma_{lk} $$

In our case, $\gamma_{ik}$ is the estimate on tertiary education for a certain type of credit(y = 1, 2, 3 and 4). Having $P_{nl}$ be the predicted probabilities of an individual choosing the different types credit then $\bar{\gamma}_{nk}$ becomes the probability weighted average of the estimate on tertiary education ($\gamma_{ik}$). Thus, to obtain the marginal effect we would just multiply the predicted probability by the difference between the estimate and the weighted average of the estimate. This yields that the true effect of an additional year of tertiary education, results in an increase in the probability of an individual or household gaining access to formal credit, holding all other variables constant. Since we want the marginal effect averaged over all individuals in our sample, we multiply by $N^{-1}$.

# Results

In this section, the estimates are presented. From this we seek to analyse the results in order to further understand what factors drove the probability of an individual receiving access to either of the respective channels of credit. Table 3 presents the marginal effects estimates or factors affecting individuals and households access to formal, informal as well as formal and informal credit. Having explained our reference option, we would like to know why there are marginal estimates for that option. 

```{r Build Dataset, echo=FALSE, warning=FALSE, include=FALSE}
knitr::opts_chunk$set(message = FALSE)
# Read the data in
finscope_2019 <- read_sav("C:/Users/User/OneDrive - University of Pretoria/Tuks/Honours/EKT 795/Research Paper/Dataset from Finscope/FinScope SA Consymer 2019 Final.sav")


# Deleting variables from Section A
f_1 <- finscope_2019 %>% 
  dplyr::select(-c(ID: ID_working,
            EACode: SP_code,
            EA_GTI_GType6: Respondent_to_Interview))

# Deleting variables from Section B  
f_2 <- finscope_2019 %>%  
  dplyr::select(-c(B2a_12: B2a_13,               #removing those who achieve goals using savings or those who sold already accumulated assets
            B2a_15: B2a_16,              #leaving B2a_14 in but consult if we should remove it    
            B2a_20: B2a_997))



# Section C

# create new column for grant
f_3 <- finscope_2019 %>% 
  mutate(Grant = case_when(C1_1 == 1 ~ 1, C1_2 == 1 ~ 1, C1_3 == 1 ~ 1, C1_4 == 1 ~ 1,    # element receives a grant = 1 and 0 otherwise
                           C1_1 == 2 ~ 0, C1_2 == 2 ~ 0, C1_3 == 2 ~ 0, C1_4 == 2 ~ 0,))

# create new column for social group
f_3 <- f_3 %>% 
  mutate(Social_group = case_when(C7_1 == 1 ~ 1, C7_2 == 1 ~ 1, C7_3 == 1 ~ 1, C7_996 == 1 ~ 1,     # element belongs to social group = 1 and 0 otherwise
                                  C7_1 == 2 ~ 0, C7_2 == 2 ~ 0, C7_3 == 2 ~ 0, C7_996 == 2 ~ 0))


# change missing values to numeric value 787
#f_3 <- f_3 %>%
 # mutate(across(C1_1:C9c_998, ~ ifelse(is.na(.), '787', as.character(.))))         

# Define the labels for each specific value (it is not working consult on this - what happens is that labels overwrite values)
#f_3$type <- NA
#f_3 <- f_3 %>% 
# mutate(type = case_when(type == 1 ~ 'daily or more often',
 #                         type == 2 ~ 'at least once a week',
  #                        type == 3 ~ 'at least once a month',
   #                       type == 4 ~ 'a few times a year',
    #                      type == 5 ~ 'once a year or often',
     #                     type == 787 ~ 'missing values '))

#Edit for above text: This is how you add labels 
# data1<-data.frame(data$totexp, data$ltotexp, data$suppins, data$phylim, data$actlim, data$totchr, data$age, data$female, data$income)
# colnames(data1)<-c("totexp", "ltotexp", "suppins", "phylim", "actlim", "totchr", "age", "female", "income")
# data1 = apply_labels(data1,
#                   totexp = "Total medical expenditure",
#                    ltotexp = "ln(totexp) if totexp > 0",
#                    suppins = "=1 if has supp priv insurance",
#                    phylim = "=1 if has functional limitation",
#                    actlim = "=1 if has activity limitation",
#                    totchr = "# of chronic problems",
#                    age = "Age",
#                    female = "=1  if female",
#                    income = "annual household income/1000"
#)


# change missing values to numeric value 787
#f_3 <- f_3 %>%
#mutate(across(C9b_1:C9b_14, ~ ifelse(is.na(.), '787', as.character(.))))         

# create dummy for frequency of using payment types for food/groceries 
f_3 <- f_3 %>% 
  mutate(Daily_or_more_often_freq_food = case_when((C9b_1 == 1 | C9b_2 == 1 | C9b_3 == 1 | C9b_4 == 1 |
                                                      C9b_6 == 1 | C9b_7 == 1 | C9b_8 == 1 | C9b_9 == 1 |
                                                      C9b_10 == 1 | C9b_11 == 1 | C9b_12 == 1 | C9b_13 == 1 |
                                                      C9b_14 == 1) ~ 1, TRUE ~ 0),
         At_least_once_a_week_freq_food = case_when((C9b_1 == 2 | C9b_2 == 2 | C9b_3 == 2 | C9b_4 == 2 |
                                                       C9b_6 == 2 | C9b_7 == 2 | C9b_8 == 2 | C9b_9 == 2 |
                                                       C9b_10 == 2 | C9b_11 == 2 | C9b_12 == 2 | C9b_13 == 2 |
                                                       C9b_14 == 2) ~ 1, TRUE ~ 0),
         At_least_once_a_month_freq_food = case_when((C9b_1 == 3 | C9b_2 == 3 | C9b_3 == 3 | C9b_4 == 3 |
                                                        C9b_6 == 3 | C9b_7 == 3 | C9b_8 == 3 | C9b_9 == 3 |
                                                        C9b_10 == 3 | C9b_11 == 3 | C9b_12 == 3 | C9b_13 == 3 |
                                                        C9b_14 == 3) ~ 1,  TRUE ~ 0),
         A_few_times_a_year_freq_food = case_when((C9b_1 == 4 | C9b_2 == 4 | C9b_3 == 4 | C9b_4 == 4 |
                                                     C9b_6 == 4 | C9b_7 == 4 | C9b_8 == 4 | C9b_9 == 4 |
                                                     C9b_10 == 4 | C9b_11 == 4 | C9b_12 == 4 | C9b_13 == 4 |
                                                     C9b_14 == 4) ~ 1,  TRUE ~ 0),
         Once_a_year_or_less_freq_food = case_when((C9b_1 == 5 | C9b_2 == 5 | C9b_3 == 5 | C9b_4 == 5 |
                                                      C9b_6 == 5 | C9b_7 == 5 | C9b_8 == 5 | C9b_9 == 5 |
                                                      C9b_10 == 5 | C9b_11 == 5 | C9b_12 == 5 | C9b_13 == 5 |
                                                      C9b_14 == 5) ~ 1,  TRUE ~ 0)
  )


# dummy for household bills excluding food/groceries 

f_3 <- f_3 %>% 
  mutate(Daily_of_more_often_freq_bills = case_when((C9c_1 == 1| C9c_2 == 1| C9c_3 == 1| C9c_4 == 1|
                                                       C9c_6 == 1| C9c_7 == 1| C9c_8 == 1| C9c_9 == 1|
                                                       C9c_10 == 1| C9c_11 == 1| C9c_12 == 1| C9c_13 == 1|
                                                       C9c_996 == 1| C9c_998 == 1) ~ 1, TRUE ~ 0),
         At_least_once_a_week_freq_bills = case_when((C9c_1 == 2| C9c_2 == 2| C9c_3 == 2| C9c_4 == 2|
                                                        C9c_6 == 2| C9c_7 == 2| C9c_8 == 2| C9c_9 == 2|
                                                        C9c_10 == 2| C9c_11 == 2| C9c_12 == 2| C9c_13 == 2|
                                                        C9c_996 == 2| C9c_998 == 2) ~ 1, TRUE ~ 0),
         At_least_once_a_month_freq_bills = case_when((C9c_1 == 3| C9c_2 == 3| C9c_3 == 3| C9c_4 == 3|
                                                         C9c_6 == 3| C9c_7 == 3| C9c_8 == 3| C9c_9 == 3|
                                                         C9c_10 == 3| C9c_11 == 3| C9c_12 == 3| C9c_13 == 3|
                                                         C9c_996 == 3| C9c_998 == 3) ~ 1, TRUE ~ 0),
         A_few_times_a_year_freq_bills = case_when((C9c_1 == 4| C9c_2 == 4| C9c_3 == 4| C9c_4 == 4|
                                                      C9c_6 == 4| C9c_7 == 4| C9c_8 == 4| C9c_9 == 4|
                                                      C9c_10 == 4| C9c_11 == 4| C9c_12 == 4| C9c_13 == 4|
                                                      C9c_996 == 4| C9c_998 == 4) ~ 1, TRUE ~ 0),
         Once_a_year_or_less_freq_bills = case_when((C9c_1 == 5| C9c_2 == 5| C9c_3 == 5| C9c_4 == 5|
                                                       C9c_6 == 5| C9c_7 == 5| C9c_8 == 5| C9c_9 == 5|
                                                       C9c_10 == 5| C9c_11 == 5| C9c_12 == 5| C9c_13 == 5|
                                                       C9c_996 == 5| C9c_998 == 5) ~ 1, TRUE ~ 0)
  )

# Deleting variables from Section C
f_3 <- f_3 %>%  
  dplyr::select(-c(C1_1: C1_4,
            C2_6: C3_18, 
            C5a: C8_14,
            C9b_1: C9b_14))


# Deleting variables from Section D
f_4 <- f_3 %>%                                          # i still need to create a remittances (money sent to other people) variable but consult 
  dplyr::select(-c(D3a_1: D8,                                     # on if we talking about cash (D3b_11_1 until D3b_11_999) vs other formal products (D3b_1_1 until D3b_9_9)
            D3b_1_1: D4,
            D7b_1_1: D8))

#Deleting variables from Section E
f_5 <- f_4 %>%  
  dplyr::select(-c(E1_1: E16_996))

#Deleting variables from Section F
f_6 <- f_5 %>%  
  dplyr::select(-c(F2: F3a_999,                      #F3b is the bank used for main income
            F4,
            F6a_1: F6b_999,
            F10_1: F10_999,
            F12: F18a_4,
            F18a_6: F18c_4_13,
            F7_F8_1_1: F7_F8_17_999,
            F18c_4_14: F23b_996))


# Deleting variables from Section H
f_7 <- f_6 %>%  
  dplyr::select(-c(H2b_1_1: H3b_18_999,                            
            H3a_6: H3b_17_999,
            H3b_19_1: H6_999))

# Deleting variables from Section J
f_8 <- f_7 %>%  
  dplyr::select(-c(J2_1_1: J2_3_5,
            J3_1_1: J3_3_98))

# Deleting variables from Section K
f_9 <- f_8 %>%  
  dplyr::select(-c(K1_1: K2_19_999,
            K5_1: K6_997,
            K9_1: K9_999))


# Deleting variables from Section L
f_10 <- f_9 %>%  
  dplyr::select(-c(L1,
            L8: L11_8))

# Deleting variables from Section M
f_11 <- f_10 %>%  
  dplyr::select(-c(Age_Groups,
            LSM_01_36: LSM_2014_TotalScore,               
            M14_1: POPS_2))


# Deleting variables from Section 
f_12 <- f_11 %>%  
  dplyr::select(-c(`Q6016#` : card_swipping_tapping))

# Deleting variables from column i
f_13 <- f_12 %>%
  dplyr::select(-c(i1_1: i4_8))


fscope2019 <- f_13

# Now we look to answer the question of what are the demographics of cross sectional units (households)

# find position of variable in dataset 
#which(names(finscope_2019) == "M13_MHI_Imputed")

# Creating variables for demographics using the population dataset 
attach(fscope2019)

# dummy for race 

fscope2019 <- fscope2019 %>% 
  mutate(
    Black = ifelse(Resp_Race == 1, 1, 0),
    Coloured = ifelse(Resp_Race == 2, 1, 0),
    Indian_Asian = ifelse(Resp_Race == 3, 1,0),
    White = ifelse(Resp_Race == 4, 1, 0) 
  )


# dummy for provinces 
fscope2019 <- fscope2019 %>% 
  mutate(
    Eastern_Cape = ifelse(Province == 1,1 , 0),
    Free_State = ifelse(Province == 2, 1 , 0),
    Gauteng = ifelse(Province == 3, 1, 0),
    KwaZulu_Natal = ifelse(Province == 4, 1 , 0),
    Limpopo = ifelse(Province == 5, 1, 0),
    Mpumalanga = ifelse(Province == 6, 1 , 0),
    North_West = ifelse(Province == 7, 1 , 0),
    Northern_Cape = ifelse(Province == 8, 1 , 0),
    Western_Cape = ifelse(Province == 9, 1, 0)
  )


# creating dummy for metro using the StatsSA definition in the survey and not the Detailed Kantar CRUM Definition
# There are five metropolitans in SA. You either from an Urban area in one 
# of the metro areas or an urban area that is not in a metro (ue Limpopo).
# If you are not from any of the above then you are from a rural (farms and traditional) area 

fscope2019 <- fscope2019 %>% 
  mutate(
    Metro_urban = ifelse(EA_GTI_GType3 == 1, 1, 0),
    Nonmetro_urban = ifelse(EA_GTI_GType3 == 2, 1, 0),
    Rural = ifelse(EA_GTI_GType3 == 3, 1, 0)
  )

# dummy for married and co-habitating (vat n sit)

fscope2019 <- fscope2019 %>% 
  mutate(
    Married = ifelse(M2 == 1, 1, 0),
    Co_habitating = ifelse(M2 == 3, 1, 0)
  )



#  dummy for employment - you either employed, unemployed by narrow definition or unemployed by expanded/strict definition 

fscope2019 <- fscope2019 %>% 
  mutate(
    Employed = case_when((M4 == 1 | M4 == 2 | M4 == 3 | M4 == 4 | 
                            M4 == 5 | M4 == 6 | M4 == 7 | M4 == 8) ~ 1, TRUE ~ 0),
    Unemployed_strict = case_when((M4 == 10 | M4 == 13 | M4 == 14 | M4 == 15) ~ 1, TRUE ~ 0),
    Unemployed_narrow = case_when((M4 == 13 | M4 == 14 | M4 == 15) ~ 1, TRUE ~ 0)
  )


# dummy for education - no education, primary, secondary and tertiary education 

fscope2019 <- fscope2019 %>% 
  mutate(
    No_education = ifelse(M3 == 1 , 1, 0),
    Primary_education = ifelse(M3 == 2 , 1, 0),
    Secondary_education = case_when((M3 == 3 | M3 == 4) ~ 1,
                                    TRUE ~ 0),
    Tertiary_education = case_when((M3 == 5 | M3 == 6 | M3 == 7) ~ 1,
                                   TRUE ~ 0)                                 # included Apprenticeship, and diploma under tertiary education
  )

# Now we turn to the question of what are the transactional behaviours of HH (are you cash based) ?

# creating dummy variable for remittances 

fscope2019 <- fscope2019 %>% 
  mutate(
    Remittances = ifelse(D1 == 1 , 1, 0),                            # from all those who have sent Remittances in the past 12 months next we look at those who sent within/ outside SA
    Remittances_withinSA = case_when((D2_1 == 1) ~ 1 , TRUE ~ 0),         # someone can send money within and outside SA (consult about how to deal with avoiding double counting or should we continue double counting (only a small sample does this)  ))
    Remittances_outsideSA = case_when((D2_2 == 1) ~ 1, TRUE ~ 0)
  )

# creating a dummy for payments of HH expenses paid via cash

fscope2019 <- fscope2019 %>% 
  mutate(
    Cash = case_when((C9a_1 == 1) ~ 1, TRUE ~ 0),                          # consult on if we should consider other methods as cash ie Wallet money (E-wallet or Instant Money) and ATM to make an EFT transfer but for now i am including them                         
    Wallet_money = case_when((C9a_10 == 1) ~ 1, TRUE ~ 0),       
    EFT_transfer = case_when((C9a_12 == 1) ~ 1, TRUE ~ 0)
  )

# dummy for if you withdraw cash immediately 

fscope2019 <- fscope2019 %>% 
  mutate(
    Withdraw_cash_immediately = case_when((F5 == 1 | F5 == 2) ~ 1, TRUE ~ 0)                   # including those who withdraw cash immediately sometimes as soon as it is deposited into bank account 
  )




# with the dust settling we now turn to finding variables which answers what is the type of credit usage?
# looking at SECTION G: BORROWING (CREDIT/LOANS), the complete survey data only asks these questions based on the past 12 months of formal, informal or no credit participation.

fscope2019 <- fscope2019 %>% 
  mutate(
    Formal_credit = case_when((G3_1 == 1 |G3_2 == 1 |G3_3 == 1 | G3_4 == 1 | G3_10 == 1) ~ 1, TRUE ~ 0),              #  added Insurance company and Micro finance institution e.g. Wonga to the definition of formal credit usuage 
    Informal_credit = case_when((G3_5 == 1 | G3_6 == 1 | G3_7 == 1 | G3_8 == 1 |                              # adding a few variables under informal credit:
                               G3_9 == 1 | G3_11 == 1 | G3_12 == 1) ~ 1, TRUE ~ 0),                                       # mashonisa, advance on salary* (might exclude this one),  #  stokvel, village bank, neighbours, friends and family 
    No_credit = ifelse(G3_998 == 1 , 1, 0)
  )



fscope2019 <- fscope2019 %>% 
  mutate(
    Credit_type = case_when( (Formal_credit == 1 ) & (Informal_credit == 0) ~ 'Formal credit', 
                              (Formal_credit == 0) & (Informal_credit == 1) ~ 'Informal credit',
                              (No_credit == 1) & (Formal_credit == 0) & (Informal_credit == 0) ~ 'No credit',
                              (Formal_credit == 1)  & (Informal_credit == 1) ~ 'Formal and Informal credit' )                   # including those who withdraw cash immediately 'sometimes' as soon as it is deposited into bank account 
  )
#table_1 <- fscope2019 %>% 
 # group_by(Credit_type) %>% 
 # summarise(n(),
  #          sum(BENCHWGT_PP))

# write_excel_csv(table_1, file = 'summary stats draft')

# dummy for if you withdraw cash immediately 

fscope2019 <- fscope2019 %>% 
  mutate(
    Male = ifelse(Resp_Gender == 1, 1, 0),
  )

# keep everything where credit type is not returning false in tthe credit type variable 
fscope2019 <-  fscope2019 %>% 
  filter((Credit_type == 0)==F)


# also we can consider different HHs that participate in different kind of lendin
# secured lending
# unsecured lending 
# informal lending 


# rename variables 
fscope2019 <- fscope2019 %>% 
  rename(
    Home_Language = M1,
    Age = Resp_Age,
    LSM = LSM_2014_Output,
    Personal_income = M12a_PMI_Imputed,
    Household_income = M13_MHI_Imputed,
    Household_size = Number_in_HH
  )
#finscope_2019 %>% count(M13_MHI_Imputed)
# To sum everything above we compile descriptive statistics 
# creating a frequency table
attach(fscope2019)

finscope_stats <- fscope2019 %>% 
  group_by(Credit_type) %>% 
  summarise(
    Household_size = weighted.mean(Household_size, w = BENCHWGT_PP),
    Age = weighted.mean(Age, w = BENCHWGT_PP),                            
    Male = weighted.mean(Male, w = BENCHWGT_PP),
    Personal_Income = weighted.mean(Personal_income, w = BENCHWGT_PP),
    Household_income = weighted.mean(Household_income, w = BENCHWGT_PP),
    Grant = weighted.mean(Grant, w = BENCHWGT_PP),
    Social_group = weighted.mean(Social_group, w = BENCHWGT_PP),
    Daily_or_more_often_freq_food = weighted.mean(Daily_or_more_often_freq_food, w = BENCHWGT_PP),
    At_least_once_a_week_freq_food = weighted.mean(At_least_once_a_week_freq_food, w = BENCHWGT_PP),
    At_least_once_a_month_freq_food = weighted.mean(At_least_once_a_month_freq_food, w = BENCHWGT_PP),
    A_few_times_a_year_freq_food = weighted.mean(A_few_times_a_year_freq_food, w = BENCHWGT_PP),
    Once_a_year_or_less_freq_food = weighted.mean(Once_a_year_or_less_freq_food, w = BENCHWGT_PP),
    Daily_of_more_often_freq_bills = weighted.mean(Daily_of_more_often_freq_bills, w = BENCHWGT_PP),
    At_least_once_a_week_freq_bills = weighted.mean(At_least_once_a_week_freq_bills, w = BENCHWGT_PP),
    At_least_once_a_month_freq_bills = weighted.mean(At_least_once_a_month_freq_bills, w = BENCHWGT_PP),
    #A_few_times_a_year_freq_bills = weighted.mean(A_few_times_a_year_freq_bills, w = BENCHWGT_PP), w = BENCHWGT_PP),
    #Once_a_year_or_less_freq_bills = weighted.mean(Once_a_year_or_less_freq_bills, w = BENCHWGT_PP),
    Black = weighted.mean(Black, w = BENCHWGT_PP),
    Coloured = weighted.mean(Coloured, w = BENCHWGT_PP),
    Indian_Asian = weighted.mean(Indian_Asian, w = BENCHWGT_PP),
    White = weighted.mean(White, w = BENCHWGT_PP),
    Eastern_Cape= weighted.mean(Eastern_Cape, w = BENCHWGT_PP),
    Free_State = weighted.mean(Free_State, w = BENCHWGT_PP), 
    Gauteng = weighted.mean(Gauteng, w = BENCHWGT_PP),
    KwaZulu_Natal = weighted.mean(KwaZulu_Natal, w = BENCHWGT_PP),
    Limpopo = weighted.mean(Limpopo, w = BENCHWGT_PP),
    Mpumalanga = weighted.mean(Mpumalanga, w = BENCHWGT_PP),
    North_West = weighted.mean(Northern_Cape, w = BENCHWGT_PP),
    Northern_Cape = weighted.mean(Northern_Cape, w = BENCHWGT_PP),
    Western_Cape = weighted.mean(Western_Cape, w = BENCHWGT_PP),
    Metro_urban = weighted.mean(Metro_urban, w = BENCHWGT_PP),
    Nonmetro_urban = weighted.mean(Nonmetro_urban, w = BENCHWGT_PP),
    Rural = weighted.mean(Rural, w = BENCHWGT_PP),
    Married = weighted.mean(Married, w = BENCHWGT_PP),
    Co_habitating= weighted.mean(Co_habitating, w = BENCHWGT_PP),
    Employed = weighted.mean(Employed, w = BENCHWGT_PP),
    Unemployed_strict = weighted.mean(Unemployed_strict, w = BENCHWGT_PP),
    Unemployed_narrow = weighted.mean(Unemployed_narrow, w = BENCHWGT_PP),
    No_education = weighted.mean(No_education, w = BENCHWGT_PP),
    Primary_education = weighted.mean(Primary_education, w = BENCHWGT_PP),
    Secondary_education = weighted.mean(Secondary_education, w = BENCHWGT_PP),
    Tertiary_education = weighted.mean(Tertiary_education, w = BENCHWGT_PP),
    Remittances = weighted.mean(Remittances, w = BENCHWGT_PP),
    Remittances_withinSA = weighted.mean(Remittances_withinSA, w = BENCHWGT_PP),
    Remittances_outsideSA = weighted.mean(Remittances_outsideSA, w = BENCHWGT_PP),
    Cash = weighted.mean(Cash, w = BENCHWGT_PP),
    Wallet_money = weighted.mean(Wallet_money, w = BENCHWGT_PP),
    EFT_transfer = weighted.mean(EFT_transfer, w = BENCHWGT_PP),
    Withdraw_cash_immediately = weighted.mean(Withdraw_cash_immediately, w = BENCHWGT_PP)
)


#fscope2019 %>% 
 # group_by(Credit_type) %>% 
  #summarise(n(),
   #         weighted.mean(Personal_income, w = BENCHWGT_PP))
 
# final sweep
fscope2019 <- fscope2019 %>%
  select(-c(A1: M7_999))
 
detach(fscope2019)

# import data into excel
#write_excel_csv(finscope_stats, file = 'descriptive stats draft15')

```

```{r Marginal effects and Regression table, echo=FALSE, warning=FALSE, include=FALSE}
knitr::opts_chunk$set(message = FALSE)

# Include Age squared
fscope2019$Agesq <- fscope2019$Age^2

# Transform income to  log income

fscope2019$Personal_income[fscope2019$Personal_income == 0] <- 1
fscope2019 %>% count(Personal_income)

fscope2019$lPersonal_income <- log(fscope2019$Personal_income)

# Creating datasets ----

finscope_2019_credit <- fscope2019 %>% 
  mutate(n=1:n())

finscope_2019_long_credit <- dfidx(finscope_2019_credit,choice="Credit_type", shape = "wide")


# Running estimates ----
credit_mlogit <- mlogit(Credit_type ~ 1 | Household_size + Age + Agesq + Male + lPersonal_income + 
                          Black + Coloured + Indian_Asian + Eastern_Cape + Free_State + Gauteng + 
                          KwaZulu_Natal + Limpopo + Mpumalanga + North_West + Western_Cape +  
                          Married + Employed + Tertiary_education + Grant + Metro_urban + Remittances + LSM, 
                          reflevel = "No credit", finscope_2019_long_credit, weights = BENCHWGT_PP)

# Calculating marginal effects manually ----

# First I generate predictions for each respondent and generate an index
predictions <- data.frame(fitted(credit_mlogit,outcome=F)) %>% mutate(n=1:n()) 

# Assigning predicted probabilities to each individual in the long dataset
finscope_2019_long_credit$Est_Prob <- 0
for (i in 1:nrow(finscope_2019_credit)) {
  finscope_2019_long_credit$Est_Prob[finscope_2019_long_credit$idx[,2]=="No credit" & finscope_2019_long_credit$n==i] <-
    predictions$No.credit[predictions$n==i]
  finscope_2019_long_credit$Est_Prob[finscope_2019_long_credit$idx[,2]=="Informal credit" & finscope_2019_long_credit$n==i] <-
    predictions$Informal.credit[predictions$n==i]
  finscope_2019_long_credit$Est_Prob[finscope_2019_long_credit$idx[,2]=="Formal credit" & finscope_2019_long_credit$n==i] <-
    predictions$Formal.credit[predictions$n==i]
  finscope_2019_long_credit$Est_Prob[finscope_2019_long_credit$idx[,2]=="Formal and Informal credit" & finscope_2019_long_credit$n==i] <-
    predictions$Formal.and.Informal.credit[predictions$n==i]
}

# the following code confirms that this was done correctly - i.e. the sum of probabilities must equal 1 for each n
# View(finscope_2019_long_credit %>% group_by(n) %>% summarise(total_prob=sum(Est_Prob)))  #consult here 

## Setting up final results table (also serves as an input to the marginal effects estimation) ----

credit_mlogit_coefficients <- summary(credit_mlogit)
credit_mlogit_coefficients <- data.frame(credit_mlogit_coefficients$CoefTable) #tibble removes the rownames - which I need to create variable names
credit_mlogit_varnames <- data.frame(var=rownames(credit_mlogit_coefficients))
credit_mlogit_varnames$variable <- unglue_vec(credit_mlogit_varnames$var,"{x}:{y}",var="x")
credit_mlogit_varnames$credit_type <- unglue_vec(credit_mlogit_varnames$var,"{x}:{y}",var="y")

credit_mlogit_results <- cbind(credit_mlogit_varnames,credit_mlogit_coefficients)
rownames(credit_mlogit_results) <- NULL
credit_mlogit_results <- credit_mlogit_results[,-1] # this will be used later to generate the final table

## Assigning coefficients to each individual ----
## Unfortunately, we need to create individual columns for each of the variables we used in the regression

### Household_size
finscope_2019_long_credit$Household_size_beta <- 0 #Note 0 will be kept for No credit"

finscope_2019_long_credit$Household_size_beta[finscope_2019_long_credit$idx[,2]=="Informal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="Household_size" & credit_mlogit_results$credit_type=="Informal credit"]
finscope_2019_long_credit$Household_size_beta[finscope_2019_long_credit$idx[,2]=="Formal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="Household_size" & credit_mlogit_results$credit_type=="Formal credit"]
finscope_2019_long_credit$Household_size_beta[finscope_2019_long_credit$idx[,2]=="Formal and Informal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="Household_size" & credit_mlogit_results$credit_type=="Formal and Informal credit"]


### lPersonal_income
finscope_2019_long_credit$lPersonal_income_beta <- 0 #Note 0 will be kept for No credit"

finscope_2019_long_credit$lPersonal_income_beta[finscope_2019_long_credit$idx[,2]=="Informal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="lPersonal_income" & credit_mlogit_results$credit_type=="Informal credit"]
finscope_2019_long_credit$lPersonal_income_beta[finscope_2019_long_credit$idx[,2]=="Formal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="lPersonal_income" & credit_mlogit_results$credit_type=="Formal credit"]
finscope_2019_long_credit$lPersonal_income_beta[finscope_2019_long_credit$idx[,2]=="Formal and Informal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="lPersonal_income" & credit_mlogit_results$credit_type=="Formal and Informal credit"]

### LSM
finscope_2019_long_credit$LSM_beta <- 0 #Note 0 will be kept for No credit"

finscope_2019_long_credit$LSM_beta[finscope_2019_long_credit$idx[,2]=="Informal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="LSM" & credit_mlogit_results$credit_type=="Informal credit"]
finscope_2019_long_credit$LSM_beta[finscope_2019_long_credit$idx[,2]=="Formal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="LSM" & credit_mlogit_results$credit_type=="Formal credit"]
finscope_2019_long_credit$LSM_beta[finscope_2019_long_credit$idx[,2]=="Formal and Informal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="LSM" & credit_mlogit_results$credit_type=="Formal and Informal credit"]

### Age
finscope_2019_long_credit$Age_beta <- 0 #Note 0 will be kept for No credit"

finscope_2019_long_credit$Age_beta[finscope_2019_long_credit$idx[,2]=="Informal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="Age" & credit_mlogit_results$credit_type=="Informal credit"]
finscope_2019_long_credit$Age_beta[finscope_2019_long_credit$idx[,2]=="Formal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="Age" & credit_mlogit_results$credit_type=="Formal credit"]
finscope_2019_long_credit$Age_beta[finscope_2019_long_credit$idx[,2]=="Formal and Informal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="Age" & credit_mlogit_results$credit_type=="Formal and Informal credit"]

### Agesq
finscope_2019_long_credit$Agesq_beta <- 0 #Note 0 will be kept for No credit"

finscope_2019_long_credit$Agesq_beta[finscope_2019_long_credit$idx[,2]=="Informal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="Agesq" & credit_mlogit_results$credit_type=="Informal credit"]
finscope_2019_long_credit$Agesq_beta[finscope_2019_long_credit$idx[,2]=="Formal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="Agesq" & credit_mlogit_results$credit_type=="Formal credit"]
finscope_2019_long_credit$Agesq_beta[finscope_2019_long_credit$idx[,2]=="Formal and Informal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="Agesq" & credit_mlogit_results$credit_type=="Formal and Informal credit"]

### Male
finscope_2019_long_credit$Male_beta <- 0 #Note 0 will be kept for No credit"

finscope_2019_long_credit$Male_beta[finscope_2019_long_credit$idx[,2]=="Informal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="Male" & credit_mlogit_results$credit_type=="Informal credit"]
finscope_2019_long_credit$Male_beta[finscope_2019_long_credit$idx[,2]=="Formal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="Male" & credit_mlogit_results$credit_type=="Formal credit"]
finscope_2019_long_credit$Male_beta[finscope_2019_long_credit$idx[,2]=="Formal and Informal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="Male" & credit_mlogit_results$credit_type=="Formal and Informal credit"]

### Black
finscope_2019_long_credit$Black_beta <- 0 #Note 0 will be kept for No credit"

finscope_2019_long_credit$Black_beta[finscope_2019_long_credit$idx[,2]=="Informal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="Black" & credit_mlogit_results$credit_type=="Informal credit"]
finscope_2019_long_credit$Black_beta[finscope_2019_long_credit$idx[,2]=="Formal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="Black" & credit_mlogit_results$credit_type=="Formal credit"]
finscope_2019_long_credit$Black_beta[finscope_2019_long_credit$idx[,2]=="Formal and Informal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="Black" & credit_mlogit_results$credit_type=="Formal and Informal credit"]

### Coloured
finscope_2019_long_credit$Coloured_beta <- 0 #Note 0 will be kept for No credit"

finscope_2019_long_credit$Coloured_beta[finscope_2019_long_credit$idx[,2]=="Informal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="Coloured" & credit_mlogit_results$credit_type=="Informal credit"]
finscope_2019_long_credit$Coloured_beta[finscope_2019_long_credit$idx[,2]=="Formal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="Coloured" & credit_mlogit_results$credit_type=="Formal credit"]
finscope_2019_long_credit$Coloured_beta[finscope_2019_long_credit$idx[,2]=="Formal and Informal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="Coloured" & credit_mlogit_results$credit_type=="Formal and Informal credit"]

### Indian_Asian
finscope_2019_long_credit$Indian_Asian_beta <- 0 #Note 0 will be kept for No credit"

finscope_2019_long_credit$Indian_Asian_beta[finscope_2019_long_credit$idx[,2]=="Informal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="Indian_Asian" & credit_mlogit_results$credit_type=="Informal credit"]
finscope_2019_long_credit$Indian_Asian_beta[finscope_2019_long_credit$idx[,2]=="Formal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="Indian_Asian" & credit_mlogit_results$credit_type=="Formal credit"]
finscope_2019_long_credit$Indian_Asian_beta[finscope_2019_long_credit$idx[,2]=="Formal and Informal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="Indian_Asian" & credit_mlogit_results$credit_type=="Formal and Informal credit"]

### Eastern_Cape
finscope_2019_long_credit$Eastern_Cape_beta <- 0 #Note 0 will be kept for No credit"

finscope_2019_long_credit$Eastern_Cape_beta[finscope_2019_long_credit$idx[,2]=="Informal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="Eastern_Cape" & credit_mlogit_results$credit_type=="Informal credit"]
finscope_2019_long_credit$Eastern_Cape_beta[finscope_2019_long_credit$idx[,2]=="Formal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="Eastern_Cape" & credit_mlogit_results$credit_type=="Formal credit"]
finscope_2019_long_credit$Eastern_Cape_beta[finscope_2019_long_credit$idx[,2]=="Formal and Informal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="Eastern_Cape" & credit_mlogit_results$credit_type=="Formal and Informal credit"]

### Free_State
finscope_2019_long_credit$Free_State_beta <- 0 #Note 0 will be kept for No credit"

finscope_2019_long_credit$Free_State_beta[finscope_2019_long_credit$idx[,2]=="Informal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="Free_State" & credit_mlogit_results$credit_type=="Informal credit"]
finscope_2019_long_credit$Free_State_beta[finscope_2019_long_credit$idx[,2]=="Formal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="Free_State" & credit_mlogit_results$credit_type=="Formal credit"]
finscope_2019_long_credit$Free_State_beta[finscope_2019_long_credit$idx[,2]=="Formal and Informal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="Free_State" & credit_mlogit_results$credit_type=="Formal and Informal credit"]

### Gauteng
finscope_2019_long_credit$Gauteng_beta <- 0 #Note 0 will be kept for No credit"

finscope_2019_long_credit$Gauteng_beta[finscope_2019_long_credit$idx[,2]=="Informal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="Gauteng" & credit_mlogit_results$credit_type=="Informal credit"]
finscope_2019_long_credit$Gauteng_beta[finscope_2019_long_credit$idx[,2]=="Formal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="Gauteng" & credit_mlogit_results$credit_type=="Formal credit"]
finscope_2019_long_credit$Gauteng_beta[finscope_2019_long_credit$idx[,2]=="Formal and Informal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="Gauteng" & credit_mlogit_results$credit_type=="Formal and Informal credit"]

### KwaZulu_Natal
finscope_2019_long_credit$KwaZulu_Natal_beta <- 0 #Note 0 will be kept for No credit"

finscope_2019_long_credit$KwaZulu_Natal_beta[finscope_2019_long_credit$idx[,2]=="Informal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="KwaZulu_Natal" & credit_mlogit_results$credit_type=="Informal credit"]
finscope_2019_long_credit$KwaZulu_Natal_beta[finscope_2019_long_credit$idx[,2]=="Formal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="KwaZulu_Natal" & credit_mlogit_results$credit_type=="Formal credit"]
finscope_2019_long_credit$KwaZulu_Natal_beta[finscope_2019_long_credit$idx[,2]=="Formal and Informal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="KwaZulu_Natal" & credit_mlogit_results$credit_type=="Formal and Informal credit"]

### Limpopo
finscope_2019_long_credit$Limpopo_beta <- 0 #Note 0 will be kept for No credit"

finscope_2019_long_credit$Limpopo_beta[finscope_2019_long_credit$idx[,2]=="Informal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="Limpopo" & credit_mlogit_results$credit_type=="Informal credit"]
finscope_2019_long_credit$Limpopo_beta[finscope_2019_long_credit$idx[,2]=="Formal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="Limpopo" & credit_mlogit_results$credit_type=="Formal credit"]
finscope_2019_long_credit$Limpopo_beta[finscope_2019_long_credit$idx[,2]=="Formal and Informal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="Limpopo" & credit_mlogit_results$credit_type=="Formal and Informal credit"]

### Mpumalanga
finscope_2019_long_credit$Mpumalanga_beta <- 0 #Note 0 will be kept for No credit"

finscope_2019_long_credit$Mpumalanga_beta[finscope_2019_long_credit$idx[,2]=="Informal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="Mpumalanga" & credit_mlogit_results$credit_type=="Informal credit"]
finscope_2019_long_credit$Mpumalanga_beta[finscope_2019_long_credit$idx[,2]=="Formal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="Mpumalanga" & credit_mlogit_results$credit_type=="Formal credit"]
finscope_2019_long_credit$Mpumalanga_beta[finscope_2019_long_credit$idx[,2]=="Formal and Informal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="Mpumalanga" & credit_mlogit_results$credit_type=="Formal and Informal credit"]

### North_West
finscope_2019_long_credit$North_West_beta <- 0 #Note 0 will be kept for No credit"

finscope_2019_long_credit$North_West_beta[finscope_2019_long_credit$idx[,2]=="Informal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="North_West" & credit_mlogit_results$credit_type=="Informal credit"]
finscope_2019_long_credit$North_West_beta[finscope_2019_long_credit$idx[,2]=="Formal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="North_West" & credit_mlogit_results$credit_type=="Formal credit"]
finscope_2019_long_credit$North_West_beta[finscope_2019_long_credit$idx[,2]=="Formal and Informal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="North_West" & credit_mlogit_results$credit_type=="Formal and Informal credit"]

### Western_Cape
finscope_2019_long_credit$Western_Cape_beta <- 0 #Note 0 will be kept for No credit"

finscope_2019_long_credit$Western_Cape_beta[finscope_2019_long_credit$idx[,2]=="Informal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="Western_Cape" & credit_mlogit_results$credit_type=="Informal credit"]
finscope_2019_long_credit$Western_Cape_beta[finscope_2019_long_credit$idx[,2]=="Formal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="Western_Cape" & credit_mlogit_results$credit_type=="Formal credit"]
finscope_2019_long_credit$Western_Cape_beta[finscope_2019_long_credit$idx[,2]=="Formal and Informal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="Western_Cape" & credit_mlogit_results$credit_type=="Formal and Informal credit"]

### Married
finscope_2019_long_credit$Married_beta <- 0 #Note 0 will be kept for No credit"

finscope_2019_long_credit$Married_beta[finscope_2019_long_credit$idx[,2]=="Informal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="Married" & credit_mlogit_results$credit_type=="Informal credit"]
finscope_2019_long_credit$Married_beta[finscope_2019_long_credit$idx[,2]=="Formal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="Married" & credit_mlogit_results$credit_type=="Formal credit"]
finscope_2019_long_credit$Married_beta[finscope_2019_long_credit$idx[,2]=="Formal and Informal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="Married" & credit_mlogit_results$credit_type=="Formal and Informal credit"]

### Employed
finscope_2019_long_credit$Employed_beta <- 0 #Note 0 will be kept for No credit"

finscope_2019_long_credit$Employed_beta[finscope_2019_long_credit$idx[,2]=="Informal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="Employed" & credit_mlogit_results$credit_type=="Informal credit"]
finscope_2019_long_credit$Employed_beta[finscope_2019_long_credit$idx[,2]=="Formal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="Employed" & credit_mlogit_results$credit_type=="Formal credit"]
finscope_2019_long_credit$Employed_beta[finscope_2019_long_credit$idx[,2]=="Formal and Informal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="Employed" & credit_mlogit_results$credit_type=="Formal and Informal credit"]

### Tertiary_education
finscope_2019_long_credit$Tertiary_education_beta <- 0 #Note 0 will be kept for No credit"

finscope_2019_long_credit$Tertiary_education_beta[finscope_2019_long_credit$idx[,2]=="Informal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="Tertiary_education" & credit_mlogit_results$credit_type=="Informal credit"]
finscope_2019_long_credit$Tertiary_education_beta[finscope_2019_long_credit$idx[,2]=="Formal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="Tertiary_education" & credit_mlogit_results$credit_type=="Formal credit"]
finscope_2019_long_credit$Tertiary_education_beta[finscope_2019_long_credit$idx[,2]=="Formal and Informal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="Tertiary_education" & credit_mlogit_results$credit_type=="Formal and Informal credit"]

### Secondary_education (not running because it was not added to  regression)
#finscope_2019_long_credit$Secondary_education_beta <- 0 #Note 0 will be kept for No credit"

#finscope_2019_long_credit$Secondary_education_beta[finscope_2019_long_credit$idx[,2]=="Informal credit"] <- 
 # credit_mlogit_results$Estimate[credit_mlogit_results$variable=="Secondary_education" & credit_mlogit_results$credit_type=="Informal credit"]
#finscope_2019_long_credit$Secondary_education_beta[finscope_2019_long_credit$idx[,2]=="Formal credit"] <- 
 # credit_mlogit_results$Estimate[credit_mlogit_results$variable=="Secondary_education" & credit_mlogit_results$credit_type=="Formal credit"]
#finscope_2019_long_credit$Secondary_education_beta[finscope_2019_long_credit$idx[,2]=="Formal and Informal credit"] <- 
 # credit_mlogit_results$Estimate[credit_mlogit_results$variable=="Secondary_education" & credit_mlogit_results$credit_type=="Formal and Informal credit"]

### No_education (not running because it was not added to  regression)
#finscope_2019_long_credit$No_education_beta <- 0 #Note 0 will be kept for No credit"

#finscope_2019_long_credit$No_education_beta[finscope_2019_long_credit$idx[,2]=="Informal credit"] <- 
 # credit_mlogit_results$Estimate[credit_mlogit_results$variable=="No_education" & credit_mlogit_results$credit_type=="Informal credit"]
#finscope_2019_long_credit$No_education_beta[finscope_2019_long_credit$idx[,2]=="Formal credit"] <- 
 # credit_mlogit_results$Estimate[credit_mlogit_results$variable=="No_education" & credit_mlogit_results$credit_type=="Formal credit"]
#finscope_2019_long_credit$No_education_beta[finscope_2019_long_credit$idx[,2]=="Formal and Informal credit"] <- 
 # credit_mlogit_results$Estimate[credit_mlogit_results$variable=="No_education" & credit_mlogit_results$credit_type=="Formal and Informal credit"]

### Remittances
finscope_2019_long_credit$Remittances_beta <- 0 #Note 0 will be kept for No credit"

finscope_2019_long_credit$Remittances_beta[finscope_2019_long_credit$idx[,2]=="Informal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="Remittances" & credit_mlogit_results$credit_type=="Informal credit"]
finscope_2019_long_credit$Remittances_beta[finscope_2019_long_credit$idx[,2]=="Formal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="Remittances" & credit_mlogit_results$credit_type=="Formal credit"]
finscope_2019_long_credit$Remittances_beta[finscope_2019_long_credit$idx[,2]=="Formal and Informal credit"] <- 
  credit_mlogit_results$Estimate[credit_mlogit_results$variable=="Remittances" & credit_mlogit_results$credit_type=="Formal and Informal credit"]

### Metro_urban
finscope_2019_long_credit$Metro_urban_beta <- 0 #Note 0 will be kept for No credit"

finscope_2019_long_credit$Metro_urban_beta[finscope_2019_long_credit$idx[,2]=="Informal credit"] <- 
 credit_mlogit_results$Estimate[credit_mlogit_results$variable=="Metro_urban" & credit_mlogit_results$credit_type=="Informal credit"]
finscope_2019_long_credit$Metro_urban_beta[finscope_2019_long_credit$idx[,2]=="Formal credit"] <- 
 credit_mlogit_results$Estimate[credit_mlogit_results$variable=="Metro_urban" & credit_mlogit_results$credit_type=="Formal credit"]
finscope_2019_long_credit$Metro_urban_beta[finscope_2019_long_credit$idx[,2]=="Formal and Informal credit"] <- 
 credit_mlogit_results$Estimate[credit_mlogit_results$variable=="Metro_urban" & credit_mlogit_results$credit_type=="Formal and Informal credit"]

### Grant
finscope_2019_long_credit$Grant_beta <- 0 #Note 0 will be kept for No credit"
finscope_2019_long_credit$Grant_beta[finscope_2019_long_credit$idx[,2]=="Informal credit"] <- 
 credit_mlogit_results$Estimate[credit_mlogit_results$variable=="Grant" & credit_mlogit_results$credit_type=="Informal credit"]
finscope_2019_long_credit$Grant_beta[finscope_2019_long_credit$idx[,2]=="Formal credit"] <- 
 credit_mlogit_results$Estimate[credit_mlogit_results$variable=="Grant" & credit_mlogit_results$credit_type=="Formal credit"]
finscope_2019_long_credit$Grant_beta[finscope_2019_long_credit$idx[,2]=="Formal and Informal credit"] <- 
 credit_mlogit_results$Estimate[credit_mlogit_results$variable=="Grant" & credit_mlogit_results$credit_type=="Formal and Informal credit"]

### Estimating individual marginal effects (me). Need to do this for each variable we include in the regression ----
finscope_2019_long_credit <- finscope_2019_long_credit %>% group_by(n) %>% 
  mutate(
    lPersonal_income_me = Est_Prob*(lPersonal_income_beta - weighted.mean(lPersonal_income_beta,w=Est_Prob)),
    LSM_me = Est_Prob*(LSM_beta - weighted.mean(LSM_beta,w=Est_Prob)),
    Age_me = Est_Prob*(Age_beta - weighted.mean(Age_beta,w=Est_Prob)),
    Agesq_me = Est_Prob*(Agesq_beta - weighted.mean(Agesq_beta,w=BENCHWGT_PP)),
    Male_me = Est_Prob*(Male_beta - weighted.mean(Male_beta,w=BENCHWGT_PP)),
    Household_size_me = Est_Prob*(Household_size_beta - weighted.mean(Household_size_beta,w=BENCHWGT_PP)),
    Black_me = Est_Prob*(Black_beta - weighted.mean(Black_beta,w=BENCHWGT_PP)),
    Coloured_me = Est_Prob*(Coloured_beta - weighted.mean(Coloured_beta,w=BENCHWGT_PP)),
    Indian_Asian_me = Est_Prob*(Indian_Asian_beta - weighted.mean(Indian_Asian_beta,w=BENCHWGT_PP)),
    Eastern_Cape_me = Est_Prob*(Eastern_Cape_beta - weighted.mean(Eastern_Cape_beta,w=BENCHWGT_PP)),
    Free_State_me = Est_Prob*(Free_State_beta - weighted.mean(Free_State_beta,w=BENCHWGT_PP)),
    Gauteng_me = Est_Prob*(Gauteng_beta - weighted.mean(Gauteng_beta,w=BENCHWGT_PP)),
    KwaZulu_Natal_me = Est_Prob*(KwaZulu_Natal_beta - weighted.mean(KwaZulu_Natal_beta,w=BENCHWGT_PP)),
    Limpopo_me = Est_Prob*(Limpopo_beta - weighted.mean(Limpopo_beta,w=BENCHWGT_PP)),
    Mpumalanga_me = Est_Prob*(Mpumalanga_beta - weighted.mean(Mpumalanga_beta,w=BENCHWGT_PP)),
    North_West_me = Est_Prob*(North_West_beta - weighted.mean(North_West_beta,w=BENCHWGT_PP)),
    Western_Cape_me = Est_Prob*(Western_Cape_beta - weighted.mean(Western_Cape_beta,w=BENCHWGT_PP)),
    Married_me = Est_Prob*(Married_beta - weighted.mean(Married_beta,w=BENCHWGT_PP)),
    Employed_me = Est_Prob*(Employed_beta - weighted.mean(Employed_beta,w=BENCHWGT_PP)),
    Tertiary_education_me = Est_Prob*(Tertiary_education_beta - weighted.mean(Tertiary_education_beta,w=BENCHWGT_PP)),
    #Secondary_education_me = Est_Prob*(Secondary_education_beta - weighted.mean(Secondary_education_beta,w=BENCHWGT_PP)),
    #No_education_me = Est_Prob*(No_education_beta - weighted.mean(No_education_beta,w=BENCHWGT_PP)),
    Remittances_me = Est_Prob*(Remittances_beta - weighted.mean(Remittances_beta,w=BENCHWGT_PP)),
    Metro_urban_me = Est_Prob*(Metro_urban_beta - weighted.mean(Metro_urban_beta,w=Est_Prob)),
    Grant_me = Est_Prob*(Grant_beta - weighted.mean(Grant_beta,w=Est_Prob))
    
    
  ) %>% 
  ungroup()

### Population weighted marginal effects ----

Marginal_effects <- finscope_2019_long_credit %>% group_by(idx[,2]) %>% 
  summarise(
    lPersonal_income = weighted.mean(lPersonal_income_me,w=BENCHWGT_PP),
    LSM = weighted.mean(LSM_me,w=BENCHWGT_PP),
    Age = weighted.mean(Age_me,w=BENCHWGT_PP),
    Agesq = weighted.mean(Agesq_me,w=BENCHWGT_PP),
    Male = weighted.mean(Male_me,w=BENCHWGT_PP),
    Household_size = weighted.mean(Household_size_me,w=BENCHWGT_PP),
    Black = weighted.mean(Black_me,w=BENCHWGT_PP),
    Coloured = weighted.mean(Coloured_me,w=BENCHWGT_PP),
    Indian_Asian = weighted.mean(Indian_Asian_me,w=BENCHWGT_PP),
    Eastern_Cape = weighted.mean(Eastern_Cape_me,w=BENCHWGT_PP),
    Free_State = weighted.mean(Free_State_me,w=BENCHWGT_PP),
    Gauteng = weighted.mean(Gauteng_me,w=BENCHWGT_PP),
    KwaZulu_Natal = weighted.mean(KwaZulu_Natal_me,w=BENCHWGT_PP),
    Limpopo = weighted.mean(Limpopo_me,w=BENCHWGT_PP),
    Mpumalanga = weighted.mean(Mpumalanga_me,w=BENCHWGT_PP),
    North_West = weighted.mean(North_West_me,w=BENCHWGT_PP),
    Western_Cape = weighted.mean(Western_Cape_me,w=BENCHWGT_PP),
    Married = weighted.mean(Married_me,w=BENCHWGT_PP),
    Employed = weighted.mean(Employed_me,w=BENCHWGT_PP),
    Tertiary_education = weighted.mean(Tertiary_education_me,w=BENCHWGT_PP),
    #Secondary_education = weighted.mean(Secondary_education_me,w=BENCHWGT_PP),
    #No_education = weighted.mean(No_education_me,w=BENCHWGT_PP),
    Remittances = weighted.mean(Remittances_me,w=BENCHWGT_PP),

    Metro_urban = weighted.mean(Metro_urban_me,w=BENCHWGT_PP),
    Grant = weighted.mean(Grant_me,w=BENCHWGT_PP)
  ) %>% rename(credit = `idx[, 2]`)


### Assigning marginal effects to final results ----
### Need to repeat this for every variable. A better way would be to create a vector with variables names and use a for loop

# Personal credit
credit_mlogit_results$`Marginal effects` <- 0

credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="lPersonal_income" & credit_mlogit_results$credit_type=="Formal and Informal credit"] <-
  Marginal_effects$lPersonal_income[Marginal_effects$credit=="Formal and Informal credit"]
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="lPersonal_income" & credit_mlogit_results$credit_type=="Formal credit"] <-
  Marginal_effects$lPersonal_income[Marginal_effects$credit=="Formal credit"]
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="lPersonal_income" & credit_mlogit_results$credit_type=="Informal credit"] <-
  Marginal_effects$lPersonal_income[Marginal_effects$credit=="Informal credit"]

# LSM
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="LSM" & credit_mlogit_results$credit_type=="Formal and Informal credit"] <-
  Marginal_effects$LSM[Marginal_effects$credit=="Formal and Informal credit"]
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="LSM" & credit_mlogit_results$credit_type=="Formal credit"] <-
  Marginal_effects$LSM[Marginal_effects$credit=="Formal credit"]
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="LSM" & credit_mlogit_results$credit_type=="Informal credit"] <-
  Marginal_effects$LSM[Marginal_effects$credit=="Informal credit"]

#Age
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="Age" & credit_mlogit_results$credit_type=="Formal and Informal credit"] <-
  Marginal_effects$Age[Marginal_effects$credit=="Formal and Informal credit"]
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="Age" & credit_mlogit_results$credit_type=="Formal credit"] <-
  Marginal_effects$Age[Marginal_effects$credit=="Formal credit"]
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="Age" & credit_mlogit_results$credit_type=="Informal credit"] <-
  Marginal_effects$Age[Marginal_effects$credit=="Informal credit"]

#Agesq
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="Agesq" & credit_mlogit_results$credit_type=="Formal and Informal credit"] <-
  Marginal_effects$Agesq[Marginal_effects$credit=="Formal and Informal credit"]
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="Agesq" & credit_mlogit_results$credit_type=="Formal credit"] <-
  Marginal_effects$Agesq[Marginal_effects$credit=="Formal credit"]
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="Agesq" & credit_mlogit_results$credit_type=="Informal credit"] <-
  Marginal_effects$Agesq[Marginal_effects$credit=="Informal credit"]

#Male
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="Male" & credit_mlogit_results$credit_type=="Formal and Informal credit"] <-
  Marginal_effects$Male[Marginal_effects$credit=="Formal and Informal credit"]
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="Male" & credit_mlogit_results$credit_type=="Formal credit"] <-
  Marginal_effects$Male[Marginal_effects$credit=="Formal credit"]
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="Male" & credit_mlogit_results$credit_type=="Informal credit"] <-
  Marginal_effects$Male[Marginal_effects$credit=="Informal credit"]

#lPersonal_income
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="lPersonal_income" & credit_mlogit_results$credit_type=="Formal and Informal credit"] <-
  Marginal_effects$lPersonal_income[Marginal_effects$credit=="Formal and Informal credit"]
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="lPersonal_income" & credit_mlogit_results$credit_type=="Formal credit"] <-
  Marginal_effects$lPersonal_income[Marginal_effects$credit=="Formal credit"]
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="lPersonal_income" & credit_mlogit_results$credit_type=="Informal credit"] <-
  Marginal_effects$lPersonal_income[Marginal_effects$credit=="Informal credit"]

#Black
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="Black" & credit_mlogit_results$credit_type=="Formal and Informal credit"] <-
  Marginal_effects$Black[Marginal_effects$credit=="Formal and Informal credit"]
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="Black" & credit_mlogit_results$credit_type=="Formal credit"] <-
  Marginal_effects$Black[Marginal_effects$credit=="Formal credit"]
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="Black" & credit_mlogit_results$credit_type=="Informal credit"] <-
  Marginal_effects$Black[Marginal_effects$credit=="Informal credit"]

#Coloured
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="Coloured" & credit_mlogit_results$credit_type=="Formal and Informal credit"] <-
  Marginal_effects$Coloured[Marginal_effects$credit=="Formal and Informal credit"]
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="Coloured" & credit_mlogit_results$credit_type=="Formal credit"] <-
  Marginal_effects$Coloured[Marginal_effects$credit=="Formal credit"]
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="Coloured" & credit_mlogit_results$credit_type=="Informal credit"] <-
  Marginal_effects$Coloured[Marginal_effects$credit=="Informal credit"]

#Indian_Asian
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="Indian_Asian" & credit_mlogit_results$credit_type=="Formal and Informal credit"] <-
  Marginal_effects$Indian_Asian[Marginal_effects$credit=="Formal and Informal credit"]
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="Indian_Asian" & credit_mlogit_results$credit_type=="Formal credit"] <-
  Marginal_effects$Indian_Asian[Marginal_effects$credit=="Formal credit"]
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="Indian_Asian" & credit_mlogit_results$credit_type=="Informal credit"] <-
  Marginal_effects$Indian_Asian[Marginal_effects$credit=="Informal credit"]

#Eastern_Cape
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="Eastern_Cape" & credit_mlogit_results$credit_type=="Formal and Informal credit"] <-
  Marginal_effects$Eastern_Cape[Marginal_effects$credit=="Formal and Informal credit"]
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="Eastern_Cape" & credit_mlogit_results$credit_type=="Formal credit"] <-
  Marginal_effects$Eastern_Cape[Marginal_effects$credit=="Formal credit"]
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="Eastern_Cape" & credit_mlogit_results$credit_type=="Informal credit"] <-
  Marginal_effects$Eastern_Cape[Marginal_effects$credit=="Informal credit"]

#Free_State
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="Free_State" & credit_mlogit_results$credit_type=="Formal and Informal credit"] <-
  Marginal_effects$Free_State[Marginal_effects$credit=="Formal and Informal credit"]
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="Free_State" & credit_mlogit_results$credit_type=="Formal credit"] <-
  Marginal_effects$Free_State[Marginal_effects$credit=="Formal credit"]
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="Free_State" & credit_mlogit_results$credit_type=="Informal credit"] <-
  Marginal_effects$Free_State[Marginal_effects$credit=="Informal credit"]

#Gauteng
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="Gauteng" & credit_mlogit_results$credit_type=="Formal and Informal credit"] <-
  Marginal_effects$Gauteng[Marginal_effects$credit=="Formal and Informal credit"]
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="Gauteng" & credit_mlogit_results$credit_type=="Formal credit"] <-
  Marginal_effects$Gauteng[Marginal_effects$credit=="Formal credit"]
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="Gauteng" & credit_mlogit_results$credit_type=="Informal credit"] <-
  Marginal_effects$Gauteng[Marginal_effects$credit=="Informal credit"]

#KwaZulu_Natal
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="KwaZulu_Natal" & credit_mlogit_results$credit_type=="Formal and Informal credit"] <-
  Marginal_effects$KwaZulu_Natal[Marginal_effects$credit=="Formal and Informal credit"]
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="KwaZulu_Natal" & credit_mlogit_results$credit_type=="Formal credit"] <-
  Marginal_effects$KwaZulu_Natal[Marginal_effects$credit=="Formal credit"]
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="KwaZulu_Natal" & credit_mlogit_results$credit_type=="Informal credit"] <-
  Marginal_effects$KwaZulu_Natal[Marginal_effects$credit=="Informal credit"]

#Limpopo
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="Limpopo" & credit_mlogit_results$credit_type=="Formal and Informal credit"] <-
  Marginal_effects$Limpopo[Marginal_effects$credit=="Formal and Informal credit"]
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="Limpopo" & credit_mlogit_results$credit_type=="Formal credit"] <-
  Marginal_effects$Limpopo[Marginal_effects$credit=="Formal credit"]
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="Limpopo" & credit_mlogit_results$credit_type=="Informal credit"] <-
  Marginal_effects$Limpopo[Marginal_effects$credit=="Informal credit"]

#Mpumalanga
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="Mpumalanga" & credit_mlogit_results$credit_type=="Formal and Informal credit"] <-
  Marginal_effects$Mpumalanga[Marginal_effects$credit=="Formal and Informal credit"]
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="Mpumalanga" & credit_mlogit_results$credit_type=="Formal credit"] <-
  Marginal_effects$Mpumalanga[Marginal_effects$credit=="Formal credit"]
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="Mpumalanga" & credit_mlogit_results$credit_type=="Informal credit"] <-
  Marginal_effects$Mpumalanga[Marginal_effects$credit=="Informal credit"]

#North_West
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="North_West" & credit_mlogit_results$credit_type=="Formal and Informal credit"] <-
  Marginal_effects$North_West[Marginal_effects$credit=="Formal and Informal credit"]
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="North_West" & credit_mlogit_results$credit_type=="Formal credit"] <-
  Marginal_effects$North_West[Marginal_effects$credit=="Formal credit"]
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="North_West" & credit_mlogit_results$credit_type=="Informal credit"] <-
  Marginal_effects$North_West[Marginal_effects$credit=="Informal credit"]

#Western_Cape
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="Western_Cape" & credit_mlogit_results$credit_type=="Formal and Informal credit"] <-
  Marginal_effects$Western_Cape[Marginal_effects$credit=="Formal and Informal credit"]
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="Western_Cape" & credit_mlogit_results$credit_type=="Formal credit"] <-
  Marginal_effects$Western_Cape[Marginal_effects$credit=="Formal credit"]
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="Western_Cape" & credit_mlogit_results$credit_type=="Informal credit"] <-
  Marginal_effects$Western_Cape[Marginal_effects$credit=="Informal credit"]

#Married
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="Married" & credit_mlogit_results$credit_type=="Formal and Informal credit"] <-
  Marginal_effects$Married[Marginal_effects$credit=="Formal and Informal credit"]
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="Married" & credit_mlogit_results$credit_type=="Formal credit"] <-
  Marginal_effects$Married[Marginal_effects$credit=="Formal credit"]
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="Married" & credit_mlogit_results$credit_type=="Informal credit"] <-
  Marginal_effects$Married[Marginal_effects$credit=="Informal credit"]

#Employed
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="Employed" & credit_mlogit_results$credit_type=="Formal and Informal credit"] <-
  Marginal_effects$Employed[Marginal_effects$credit=="Formal and Informal credit"]
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="Employed" & credit_mlogit_results$credit_type=="Formal credit"] <-
  Marginal_effects$Employed[Marginal_effects$credit=="Formal credit"]
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="Employed" & credit_mlogit_results$credit_type=="Informal credit"] <-
  Marginal_effects$Employed[Marginal_effects$credit=="Informal credit"]

#Tertiary_education
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="Tertiary_education" & credit_mlogit_results$credit_type=="Formal and Informal credit"] <-
  Marginal_effects$Tertiary_education[Marginal_effects$credit=="Formal and Informal credit"]
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="Tertiary_education" & credit_mlogit_results$credit_type=="Formal credit"] <-
  Marginal_effects$Tertiary_education[Marginal_effects$credit=="Formal credit"]
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="Tertiary_education" & credit_mlogit_results$credit_type=="Informal credit"] <-
  Marginal_effects$Tertiary_education[Marginal_effects$credit=="Informal credit"]

#Remittances
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="Remittances" & credit_mlogit_results$credit_type=="Formal and Informal credit"] <-
  Marginal_effects$Remittances[Marginal_effects$credit=="Formal and Informal credit"]
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="Remittances" & credit_mlogit_results$credit_type=="Formal credit"] <-
  Marginal_effects$Remittances[Marginal_effects$credit=="Formal credit"]
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="Remittances" & credit_mlogit_results$credit_type=="Informal credit"] <-
  Marginal_effects$Remittances[Marginal_effects$credit=="Informal credit"]

#Metro_urban
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="Metro_urban" & credit_mlogit_results$credit_type=="Formal and Informal credit"] <-
 Marginal_effects$Metro_urban[Marginal_effects$credit=="Formal and Informal credit"]
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="Metro_urban" & credit_mlogit_results$credit_type=="Formal credit"] <-
Marginal_effects$Metro_urban[Marginal_effects$credit=="Formal credit"]
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="Metro_urban" & credit_mlogit_results$credit_type=="Informal credit"] <-
 Marginal_effects$Metro_urban[Marginal_effects$credit=="Informal credit"]

#Grant
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="Grant" & credit_mlogit_results$credit_type=="Formal and Informal credit"] <-
 Marginal_effects$Grant[Marginal_effects$credit=="Formal and Informal credit"]
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="Grant" & credit_mlogit_results$credit_type=="Formal credit"] <-
Marginal_effects$Grant[Marginal_effects$credit=="Formal credit"]
credit_mlogit_results$`Marginal effects`[credit_mlogit_results$variable=="Grant" & credit_mlogit_results$credit_type=="Informal credit"] <-
 Marginal_effects$Grant[Marginal_effects$credit=="Informal credit"]

## Providing final table to be inserted into report ----
credit_mlogit_results <- credit_mlogit_results %>% rename(`Std Error` = Std..Error,
                                                          `Pr(>|z|)` = Pr...z..)
credit_mlogit_results <- credit_mlogit_results[-c(1:3),] # removing intercepts. Cant generate marginal effects for them and table should be consistent
credit_mlogit_results$Estimate <- credit_mlogit_results$`Marginal effects`
credit_mlogit_results$`Marginal effects` <- NULL
credit_mlogit_results <- credit_mlogit_results %>% rename(`Marginal effects`=Estimate)

#Creating level of significance stars for table
credit_mlogit_results$star <- case_when(credit_mlogit_results$`Pr(>|z|)` >=0 & credit_mlogit_results$`Pr(>|z|)` <= 0.005 ~ "***", 
                                        credit_mlogit_results$`Pr(>|z|)` >=0 & credit_mlogit_results$`Pr(>|z|)` <= 0.01 ~ "***",
                                        credit_mlogit_results$`Pr(>|z|)` >=0 & credit_mlogit_results$`Pr(>|z|)` <= 0.05 ~ "**",
                                        credit_mlogit_results$`Pr(>|z|)` >=0 & credit_mlogit_results$`Pr(>|z|)` <= 0.1 ~ "*",
                                        credit_mlogit_results$`Pr(>|z|)`>0.1 ~ "")

cmodel <- credit_mlogit_results[,-c(3:7)]
credit_mlogit_results1 <- formatC(credit_mlogit_results$`Marginal effects`, format = "f", digits=3)
credit_mlogit_results2 <- formatC(credit_mlogit_results$`Std Error`, format = "f", digits=3)
cmodel <- data.frame(cbind(cmodel, credit_mlogit_results1, credit_mlogit_results2))
colnames(cmodel)[colnames(cmodel) == "credit_mlogit_results1"] <- "Marginal Effects"
colnames(cmodel)[colnames(cmodel) == "credit_mlogit_results2"] <- "Std Error"
cmodel <- cbind(cmodel, credit_mlogit_results$star)
colnames(cmodel)[colnames(cmodel) == "credit_mlogit_results$star"] <- "star"

# Changing row names

cmodel <- cmodel %>%
  mutate(variable = if_else(variable == "Household_size", "Household size",
                               if_else(variable == "lPersonal_income", "Log of personal income",
                                        if_else(variable == "Agesq", "Age squared",
                                       if_else(variable == "Indian_Asian", "Indian Asian", 
                                               if_else(variable == "Free_State", "Free State", 
                                                       if_else(variable == "KwaZulu_Natal", "KwaZulu Natal",
                                                               if_else(variable == "North_West", "North West",
                                                                       if_else(variable == "Western_Cape", "Western Cape",
                                                                               if_else(variable == "Eastern_Cape", "Eastern Cape",
                                                                               if_else(variable == "Tertiary_education", "Tertiary education",
                                                                                       if_else(variable == "Metro_urban", "Metro urban", variable)))))))))))
  )



# Assigning stars to estimated marginal effects and placing std errors in brackets
cmodel$`Marginal Effects` <- paste0(format(cmodel$`Marginal Effects`,digits=1,nsmall=4),
                                                   cmodel$star)
cmodel$`Std Error` <- paste0("(",format(cmodel$`Std Error`,digits=1,nsmall=4),")")
cmodel$star <- NULL


#Converting to a wide format
#credit_mlogit_results <- credit_mlogit_results[,-c(5:6)] #dont need the P value and z-value
cmodel <- cmodel %>%  
  pivot_wider(names_from = credit_type, values_from = c(`Marginal Effects`,`Std Error`)) 

# Placing var
Formal_credit <- cmodel[,c("variable","Marginal Effects_Formal credit","Std Error_Formal credit")]
Formal_credit <- Formal_credit %>% pivot_longer(!variable,names_to="params",values_to = "Formal credit")
Formal_credit$params <- NULL

Formal_Informal_credit <- cmodel[,c("variable","Marginal Effects_Formal and Informal credit","Std Error_Formal and Informal credit")]
Formal_Informal_credit <- Formal_Informal_credit %>% pivot_longer(!variable,names_to="params",values_to = "Formal and Informal credit")
Formal_Informal_credit$params <- NULL

Informal_credit <- cmodel[,c("variable","Marginal Effects_Informal credit","Std Error_Informal credit")]
Informal_credit <- Informal_credit %>% pivot_longer(!variable,names_to="params",values_to = "Informal credit")
Informal_credit$params <- NULL

## Final Table ----
final_results <- cbind(Formal_credit,Formal_Informal_credit[,2],Informal_credit[,2])

## Remove std error row
final_results$n <- 1:nrow(final_results)
final_results$variable[final_results$n%%2==0] <- "" # std errors rows are all even numbered
final_results$n <- NULL
final_results <-  final_results %>% rename(" " = variable)


```

```{r Regression Output, echo=FALSE, warning=FALSE}
#reg_est <- read_xlsx("C:/Users/User/OneDrive - University of Pretoria/Tuks/Honours/EKT 795/Research Paper/Building Dataset code/regression_estimates_final.xlsx")

kable(final_results,longtable=T,caption = "Regression Estimates for Multinomial Regression",booktabs=T,linesep="", digits = 3) %>% 
  kable_styling(latex_options = c("striped", "HOLD_position", "repeat_header")) %>% 
  kable_styling(font_size = 8) %>% 
  footnote(general = c("Observations: 4,964",
             "Percentage correctly predicted: 85.75",
           "Log Likelihood: -2.667.386",
           "Likelihood Ratio Test: 1,296.429*** (df = 72)",
           "Pseudo R-squared: .196"),
            symbol = ("Significance levels:  ‘***’ 0.01 ‘**’ 0.05 ‘*’ 0.1")) %>% 
  row_spec(0, bold = T) %>% 
  column_spec(1, bold = T, width = "5cm")

```


```{r Goodness of Fit, echo=FALSE, include=FALSE}

predic <- predictions %>% 
  rowwise() %>% 
  mutate(y_predict = names(predictions)[which.max(c_across(No.credit: Informal.credit))])

predic <- predic %>% select(y_predict)

predic <- predic %>%
  mutate(y_predict1 = if_else(y_predict == "No.credit", "No credit",
                               if_else(y_predict == "Formal.and.Informal.credit", "Formal and Informal credit", 
                                       if_else(y_predict == "Formal.credit", "Formal credit", 
                                               if_else(y_predict == "Informal.credit", "Informal credit", y_predict))))
  )

predic <- predic %>% select(y_predict1)

attach(fscope2019)
goodness <- cbind(predic, Credit_type)

goodness$no_correctly_predicted[predic==Credit_type] <- 1
goodness$no_correctly_predicted[is.na(goodness$no_correctly_predicted)] <- 0  

n = 4694
x = sum(goodness$no_correctly_predicted)

percent = x/n
```


# Determinants of Access to Credit

We find that, household size is only significant for the informal credit market with no significance for the other channels of credit. Nonetheless, the marginal effects across all channels of credit are negligible. Our age variable provides us with statistically significant results across all channels of credit. This is consistent with expectation, in that, the older an individual becomes, the more likely they will be able one is to take on credit either for short term consumption or long term productive reasons. We also have evidence of nonlinearity, that is nonlinear marginal effects of age squared which also proves to be consistent with expectation. However, employment surprising seems to negatively and statistically significantly at a 10% level to reduce an individual's probability of having access to formal credit. Although, it is positive and significant at a 1% level for the combination of formal and informal credit.  Employment and educational attainment may not be as important for access to informal credit. Table 3 validates this as shown by the respective levels of significance. Being married and being male is only significant for informal as well as for formal and informal access to credit respectively. 

Higher income is associated with a better likelihood of access to formal credit. Since we have this as a semi-elasticity, we find that, if an individual's income increases by 10% this translates to a by 0.35 percentage point rise the probability of access to formal credit, once other factors have been controlled for. The marginal effect for the log of personal income is 8.75x higher for access to formal credit compared to access for informal credit, which is a substantially large difference. This also indicates how much of importance, personal income is in improving an individuals access to a formal channel of credit. Income is significant across all type of credit in the results. Grant individuals, who have receive this as a source of income, are more likely to have access to informal credit at a 5% level of significance.   

In table 2, we found Black individuals having a greater proportion of access to informal credit. This also held up for the Coloured individuals, who for this group, access to informal credit was the second highest after no access to credit. In our results, we note Black and Coloured individuals both with a positive and statistically significant at a 1% level probability of having access to informal credit, than White individuals our base group. On the contrary, Indian or Asian individuals indicate a negative and statistically significant probability of having access to formal credit, than White individuals our base group. This is interesting, since access to formal credit was the second largest proportion, with respect to the other credit types in table 2. 

Moreover, a higher educational attainment seems to improve your probability of gaining access to formal credit. That is, at a 1% level of significance, tertiary education improves your probability by 0.02, after controlling for other factors. Furthermore, geographically speaking, Free State as well as Gauteng are statistically more likely to have access to formal credit. Interestingly, residing in Free State increases your probability of having access to formal credit by 0.046% which is 1.36 percentage points higher than Gauteng, with Northern Cape as our base group, holding all other factors constant. 

Hereafter, we find that individuals that partake in remittances being inside or outside South Africa are statistically less likely to gain access to formal, but more likely for informal and the combination of formal and informal credit. We expect formal lending institutions to be more cautious about lending to customers that send money out of the country. Lastly, we note that a higher LSM (living standard measure) corresponds to gaining access to the combination of formal and informal, as this is statistically significant only for this channel of credit.

Overall, the goodness of fit measures are sound. Given our various credit type outcomes, the number for which our model correctly predicted the type of credit that they used. We find that, 85.75% of our sample held up and was accounted for by the model. The pseudo r-squared, which is equivalent to the r-squared for OLS and based on log-likelihoods, is 19.6% for the model. The likelihood ratio test is significant at a 1% level. 

# Discussion

Given the estimates from the results section we found various household characteristics and explanatory variables statistically significant either across all credit channels or for selected credit channels. An addition from an evidence point of view is how we try to understand the impact of respective explanatory variables on the combination of formal and informal credit. The significance held up in line with most estimates. However, LSM was the only statistically significant variable for this channel of credit with respect to the other channels. Higher LSM does not explain whether an individual or household will gain access to either informal or formal credit; despite that, it is an almost negligible marginal effect, it does explain that higher LSM increased the likelihood of obtaining access to formal and informal credit. This is similar for our coefficient on being male. 

In line with prior research, we can make inference that perhaps certain factors do not play as a highlighted role in the earlier 2000s in terms of obtaining access to credit. Such as for geography, the distance from financial institutions does not play as a bigger role. Even though the FSC has timeously communicated that more bank branches be built in rural areas, digitization seems to be leapfrogging the phase of physical infrastructure. As a result of financial institutions going digital, online banking has simplified what initially were administratively challenging problems. Effectively, making it more easier to obtain credit. From a regulatory perspective, the Usury Act protected financial institutions from partaking unsecured lending segments and from extending credit for lower loan amounts and higher interest rates, effectively governing credit extension transactions and protecting customers from risks of defaulting [@mohane2000effects]. The FSC as well as the NCA, were front runners of driving economic transformation from a financial inclusion and access to credit point of view respectively. For instance, the NCA allowed for more certainty within the unsecured lending market which saw restriction outlaid by the Usury Act fall away, effectively allowing for growth for the likes Capitec as well as the dominant big four Banks [@Makhaya2016]. This in turn made it easier for previously unbanked and middle to lower class individuals also participate in the financial sector. Moreover, gain access to various credit segments. Despite that, there has been satisfying progress with regard to access to credit, especially with the advancement of technology and more digitization of financial institutions product and service offering. 

It is interesting that being married only significantly explains why individuals have access to informal credit and not the other channels. Expectation was that there be significance across all channels of credit, since more married households might consider taking up formal credit via mortgage loans and perhaps vehicle financing. Also, given that a married couple might present a higher potential household income; although, it would be cumbersome not to consider that household expenditure might also increase. That is, a married couple might have a dual income household but having children might add constraints on the household budget with new expenses to consider such as tuition, medical costs, extra-curricular activities and other factors for consideration. 

# Limitations and areas for further research

The limitation of our selected estimation model, the multinomial logit model, is that we do not have supply-side constraints. One of which is the quality of services offered by borrowers of capital. A consequence of this is that there could be a disconnect with customers expectations with respect to being to make an adequate comparison across borrowers. This might make it more challenging to asses which bank in the formal credit market can address your concern. Hence, having information on the quality service might create transparency in the credit and open room for an enhanced experience. The last and most important constraint is prices. Banks use different models to assess an individuals likelihood of defaulting. As a result, understanding what feeds into the pricing of different banks may assist individuals in making well informed decisions. As it stands, customer only use their credit score as a measure or bargaining tool when it comes to negotiating a lower price (interest rate) for capital. However, this may look different for customer A and customer B as inherently their characteristic and credit history will differ. The extent as to how these constraints effects the levels of accessibility that individuals in South Africa is unknown and could offer individuals with better information prior to making contractually binding decisions. Another limitation of our study is that we do not consider the effects or harms that could emanate from credit access. We note that a positive effect has been improved welfare. However, there negative effect of access to credit could come in the form of risks of over indebtedness. For instance, unsecured lending channel's spending trends indicates 47% of credit active consumers being three of more months in arrears, while averaging a salary or wage of less than R7500.


# Conclusion

In this paper, we extended the literature on the determinants of access to credit in South Africa at individual level. We studied the different credit types or categories that an individual might be classified under given various respective household characteristics as well as other covariates that explain this. We then further included an added level of nuance by incorporating the combination of formal and informal credit, which was not a choice variable in previous literature owing to the banking sector as well as the regulation of credit being relatively new at the time. 

Our evidence of how the landscape of credit in South Africa has evolved since the early 2000s. The finding show that, geography or distance to financial institutions no longer plays a big role in determining whether an individual gains access to different types of credit. From an administrative view, the advancement of South Africa's digit banking technology has led to more individuals easily being able to obtain credit. Hence, the more important covariates that explain an individuals probability to gain access to credit is age, income, educational attainment, employment status as well as levels of remittances. 

Building wealth as individual in  most cases is better financed through a formal institution. Individuals who struggle to provide future earnings potential, higher educational attainment levels and younger in age may face barriers in acquiring access to formal credit. This comes as a consequence of financial institutions assessing a high risk profile for the individual; subsequently, a high default rate. High levels of indebtedness in South Africa and even the high debt to disposable income overlays an argument that individual preferences for credit are leaning more toward short term consumption purposes. Owing to this limitation, we did not evaluate the overall welfare effects of credit usage and if it is being used wisely or recklessly. Our study, extended the literature on access to credit and what factors influence this at individual level, for which we conclude there has been significant growth.  



\newpage

# Bibilography 



